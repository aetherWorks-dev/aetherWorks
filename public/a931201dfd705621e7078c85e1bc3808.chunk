******************************)PROCEDURE CPane.WindToFrame (qdPt: Point;								VAR framePt: LongPt);	BEGIN		framePt.h := Longint(qdPt.h) + hOrigin;		framePt.v := Longint(qdPt.v) + vOrigin;	END;(******************************************************************************}{ WindToFrameR}{}{		Convert a rectangle from Window coords to the Frame coords of a Pane}{ ******************************************************************************)PROCEDURE CPane.WindToFrameR (qdRect: Rect;								VAR frameRect: LongRect);	BEGIN		QDToLongRect(qdRect, frameRect);		OffsetLongRect(frameRect, hOrigin, vOrigin);	END;(******************************************************************************}{ FrameToWind}{}{		Convert a point from the Frame coords of a Pane to Window coords}{ ******************************************************************************)PROCEDURE CPane.FrameToWind (framePt: LongPt;								VAR qdPt: Point);	BEGIN		qdPt.h := Longint(framePt.h) - hOrigin;		qdPt.v := Longint(framePt.v) - vOrigin;	END;(******************************************************************************}{ FrameToWindR}{}{		Convert a rectangle from the Frame coords of a Pane to Window coords}{ ******************************************************************************)PROCEDURE CPane.FrameToWindR (frameRect: LongRect;								VAR qdRect: Rect);	BEGIN		OffsetLongRect(frameRect, -hOrigin, -vOrigin);		LongToQDRect(frameRect, qdRect);	END;(******************************************************************************}{ EnclToFrame}{}{		Convert a point from the Frame coords of the enclosure to the}{		Frame coords of the Pane}{ ******************************************************************************)PROCEDURE CPane.EnclToFrame (VAR thePoint: LongPt);	VAR		enclHOrigin: Longint;		enclVOrigin: Longint;	BEGIN		itsEnclosure.GetOrigin(enclHOrigin, enclVOrigin);		thePoint.h := thePoint.h + hOrigin - enclHOrigin;		thePoint.v := thePoint.v + vOrigin - enclVOrigin;	END;(******************************************************************************}{ EnclToFrameR}{}{		Convert a rectangle from the Frame coords of the enclosure to the}{		Frame coords of the Pane}{ ******************************************************************************)PROCEDURE CPane.EnclToFrameR (VAR theRect: LongRect);	VAR		enclHOrigin: Longint;		enclVOrigin: Longint;	BEGIN		itsEnclosure.GetOrigin(enclHOrigin, enclVOrigin);		OffsetLongRect(theRect, hOrigin - enclHOrigin, vOrigin - enclVOrigin);	END;(******************************************************************************}{ FrameToEncl}{}{		Convert a point from the Frame coords of a Pane to the}{		Frame coords of its enclosure}{ ******************************************************************************)PROCEDURE CPane.FrameToEncl (VAR thePoint: LongPt);	VAR		enclHOrigin: Longint;		enclVOrigin: Longint;	BEGIN		itsEnclosure.GetOrigin(enclHOrigin, enclVOrigin);		thePoint.h := thePoint.h + enclHOrigin - hOrigin;		thePoint.v := thePoint.v + enclVOrigin - vOrigin;	END;(******************************************************************************}{ FrameToEnclR}{}{		Convert a rectangle from the Frame coords of a Pane to the}{		Frame coords of its enclosure}{ ******************************************************************************)PROCEDURE CPane.FrameToEnclR (VAR theRect: LongRect);	VAR		enclHOrigin: Longint;		enclVOrigin: Longint;	BEGIN		itsEnclosure.GetOrigin(enclHOrigin, enclVOrigin);		OffsetLongRect(theRect, enclHOrigin - hOrigin, enclVOrigin - vOrigin);	END;(******************************************************************************}{ FrameToGlobalR {OVERRIDE}	{Convert a rectangle from Frame to Global coordinates}(******************************************************************************}PROCEDURE CPane.FrameToGlobalR (frameRect: LongRect;								VAR globalRect: Rect);	VAR		theOffset: Point;	BEGIN		LongToQDRect(frameRect, globalRect);		theOffset := WindowPeek(macPort)^.contRgn^^.rgnBBox.topLeft;		OffsetRect(globalRect, theOffset.h - hOrigin, theOffset.v - vOrigin);	END;(******************************************************************************}{ TrackMouse }{}{		Follow the mouse while it is being held down and repeatedly inform}{		a specified Task of the mouse location}{ ******************************************************************************)PROCEDURE CPane.TrackMouse (theTask: CMouseTask;								startPt: LongPt;								VAR pinRect: LongRect);	VAR		currPt: LongPt;		prevPt: LongPt;		macEvent: EventRecord;		qdPt: Point;	BEGIN		Prepare;		theTask.BeginTracking(startPt);		prevPt := startPt;		currPt := startPt;					(* ??? We could call WaitNextEvent	*)					(*   here to give background apps	*)					(*   some CPU time. However, this	*)					(*   makes mouse tracking a little	*)					(*   bit sluggish.					*)		WHILE StillDown DO	(* Track while button is pressed	*)			BEGIN				Prepare;				GetMouse(qdPt);				QDToFrame(qdPt, currPt);				PinInRect(pinRect, currPt);				theTask.KeepTracking(currPt, prevPt, startPt);				prevPt := currPt;			END;		Prepare;		IF (OSEventAvail(mUpMask, macEvent)) THEN			BEGIN				qdPt := macEvent.where;				GlobalToLocal(qdPt);				QDToFrame(qdPt, currPt);			END;		PinInRect(pinRect, currPt);		theTask.EndTracking(currPt, prevPt, startPt);	END;(******************************************************************************}{ QDToFrame}{}{		Convert a point from QuickDraw coords to the Frame coords of a Pane.}{		The qdPt parameter is assumed to be in whatever QuickDraw's idea}{		of the Pane's local coordinate system is. Without long coordinates,}{		this matches Frame coordinates. With long coordinates, we have to}{		account for both the frame's origin and the partial offsetting}{		we apply to QuickDraw's origin.}{ ******************************************************************************)PROCEDURE CPane.QDToFrame (qdPt: Point;								VAR framePt: LongPt);	BEGIN		Prepare;		IF (usingLongCoord) THEN			BEGIN				WindToFrame(qdPt, framePt);				framePt.h := framePt.h - thePort^.portRect.left;				framePt.v := framePt.v - thePort^.portRect.top;			END		ELSE			QDToLongPt(qdPt, framePt);	END;(******************************************************************************}{ QDToFrameR}{}{		Convert a rectangle from QuickDraw coords to the Frame coords of a Pane}{ ******************************************************************************)PROCEDURE CPane.QDToFrameR (qdRect: Rect;								VAR frameRect: LongRect);	BEGIN		Prepare;		IF (usingLongCoord) THEN			BEGIN				WindToFrameR(qdRect, frameRect);				OffsetLongRect(frameRect, -thePort^.portRect.left, -thePort^.portRect.top);			END		ELSE			QDToLongRect(qdRect, frameRect);	END;(******************************************************************************}{ FrameToQD}{}{		Convert a point from the Frame coords of a Pane to QuickDraw coords}{ ******************************************************************************)PROCEDURE CPane.FrameToQD (framePt: LongPt;								VAR qdPt: Point);	BEGIN		Prepare;		IF (usingLongCoord) THEN			BEGIN				FrameToWind(framePt, qdPt);				qdPt.h := qdPt.h + thePort^.portRect.left;				qdPt.v := qdPt.v + thePort^.portRect.top;			END		ELSE			LongToQDPt(framePt, qdPt);	END;(******************************************************************************}{ FrameToQDR}{}{		Convert a rectangle from the Frame coords of a Pane to QuickDraw coords}{ ******************************************************************************)PROCEDURE CPane.FrameToQDR (frameRect: LongRect;								VAR qdRect: Rect);	BEGIN		Prepare;		IF (usingLongCoord) THEN			BEGIN				FrameToWindR(frameRect, qdRect);				OffsetRect(qdRect, thePort^.portRect.left, thePort^.portRect.top);			END		ELSE			LongToQDRect(frameRect, qdRect);	END;(******************************************************************************}{ SectAperture}{}{	Clip the LongRect to the pixels visible thru the aperture, and return}{	the result in a QD rect. Returns TRUE if resulting rect is non-empty.}{ ******************************************************************************)FUNCTION CPane.SectAperture (srcRect: LongRect;								VAR destRect: Rect): Boolean;	BEGIN		Prepare;		IF (SectLongRect(aperture, srcRect, srcRect)) THEN			BEGIN				FrameToQDR(srcRect, destRect);				SectAperture := NOT EmptyRect(destRect);			END		ELSE			BEGIN				SetRect(destRect, 0, 0, 0, 0);				SectAperture := FALSE;			END;	END;(******************************************************************************}{ GetHelpResID}{}{	Return the resource ID of the 'hrct' resource that has the }{	help balloon info for this pane. This method passes the message to the}{	pane's enclosing window, which return the ID to be used for all panes}{	in the window.}{	}{ ******************************************************************************)FUNCTION CPane.GetHelpResID: Integer;	BEGIN		GetHelpResID := GetWindow.GetHelpResID;	END;{****************************************************}{	 Pane_Contains 	}{}{	        Check whether a Pane contains a specified point }{}{****************************************************}FUNCTION Pane_Contains (thePane: CPane;								thePoint: Ptr): Boolean;	BEGIN		Pane_Contains := thePane.Contains(PointPtr(thePoint)^);	END;{****************************************************}{	 Pane_AdjustToEnclosure 	}{}{	   Tell a pane to adjust to change in the size of its enclosure }{}{****************************************************}PROCEDURE Pane_AdjustToEnclosure (thePane: CPane;								delta: RectPtr);	BEGIN		thePane.AdjustToEnclosure(delta^);	END;{****************************************************}{	 Pane_Draw 	}{}{	   Prepare and Draw a Pane }{}{****************************************************}PROCEDURE Pane_Draw (thePane: CPane;								area: RectPtr);	VAR		paneArea: Rect;		(* Area in Pane's Frame coords		*)		paneAperture: Rect;		border: CPaneBorder;		paneFrame, borderRect: Rect;	BEGIN							(* Only draw if pane is visible		*)		IF (thePane.ReallyVisible) THEN			BEGIN				border := thePane.GetBorder;				IF (border <> NIL) THEN					BEGIN				(* Get the pane's frame in window coordinates		*)				(* then ask the border for the border rect.			*)				(* If that rect intersects the area to draw, then	*)				(* go ahead and draw the border						*)						thePane.FrameToWindR(thePane.frame, paneFrame);						borderRect := paneFrame;						border.CalcBorderRect(borderRect);						IF (SectRect(borderRect, area^, borderRect)) THEN							BEGIN								IF (thePane.printing) THEN									SetOrigin(0, 0)								ELSE									thePane.GetWindow.Prepare;								ClipRect(borderRect);								ForceNextPrepare;								border.DrawBorder(paneFrame);							END;					END;				IF (NOT thePane.printing) THEN					BEGIN					(* DrawAll always receives the area in Window 			*)					(* coordinates. If we're not printing, clip the			*)					(* area to the aperture.								*)						thePane.FrameToWindR(thePane.aperture, paneAperture);				(* See if area intersects the		*)				(*   aperture of the Pane			*)				(*   be drawn.						*)						IF (SectRect(paneAperture, area^, paneArea)) THEN							BEGIN					(* Some portion of this Pane must	*)					(* be drawn							*)								thePane.DrawAll(paneArea);							END;					END				ELSE				(* printing, don't clip the area		*)					BEGIN						paneArea := area^;						thePane.DrawAll(paneArea);					END;			END;	END;END.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          2¾      Ê      Ú      þ      CPane.p   TEXTPJMM@         Z  TEXTPJMM@                       ¤Wc      L  	Ö      	è      	ú      
      
      
0      
B      
T      
f      
x      
Š      
œ      
®      
À      
Ò      
ä         €   1.1.2	TCL 1.1.2           2 i’œü    2  vers   
 ÿÿ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            (******************************************************************************}{ CPaneBorder.p}{}{		CPaneBorder is a helper class for CPane. It draws a border}{		outside the frame of a client frame when requested. It also}{		can calculate the rectangle that encompasses the pane and its}{		border. CPaneBorder makes no assumptions about which coordinate}{		system to use: it always calculates and draws relative to }{		a rectangle that is passed to it.}{		CPaneBorder can draw rectangular, shadowed rectangular,}{		rounded rectangular, or oval borders. It may be subclassed}{		to provide additional borders.}{		}{	SUPERCLASS = CObject}{}{	Copyright © 1991 Symantec Corporation. All rights reserved.}{}{}{ ******************************************************************************)UNIT CPaneBorder;INTERFACEUSES	TCL;IMPLEMENTATION(******************************************************************************}{ IPaneBorder}{}{ 	Initialize a PaneBorder. The borderFlags are taken from the}{ 	argument, and the other border attributes are initialized}{ 	with defaults. All the defaults may be changed via methods.}{******************************************************************************)PROCEDURE CPaneBorder.IPaneBorder (aBorderFlags: Longint);	BEGIN		borderPen.h := 1;		borderPen.v := 1;		shadowOffset.h := 2;		shadowOffset.v := 2;		shadowPen.h := 2;		shadowPen.v := 2;		roundDiameter.h := 16;		roundDiameter.v := 16;		doShadow := FALSE;		SetRect(margin, 0, 0, 0, 0);		SetBorderFlags(aBorderFlags);		SetPattern(black);	END;(******************************************************************************}{ IResPaneBorder}{}{ 	Initialize a pane border from a 'PBrd' resource.}{}{******************************************************************************)FUNCTION GetPat (patID: Integer): PatHandle;	BEGIN		GetPat := GetPattern(patID);	END;PROCEDURE CPaneBorder.IResPaneBorder (resID: Integer);	VAR		savedAlloc: Boolean;		template: PaneBorderTempHndl;		t: PaneBorderTempPtr;		patID: Integer;		pat: PatHandle;		fi: FailInfo;	PROCEDURE HandleFailure (error: Integer;									message: Longint);		BEGIN			ForgetResource(template);			ForgetResource(pat);		END;	BEGIN		pat := NIL;		patID := 0;		template := NIL;		CatchFailures(fi, HandleFailure);		doShadow := FALSE;		savedAlloc := SetAllocation(kAllocCanFail);		template := PaneBorderTempHndl(GetResource(kPaneBorderRes, resID));		IF (template <> NIL) & (template^^.patID <> 0) THEN			BEGIN				patID := template^^.patID;				pat := GetPat(patID);			END;		savedAlloc := SetAllocation(savedAlloc);		FailNILRes(template);		IF (patID > 0) THEN			FailNILRes(pat);		IF (pat <> NIL) THEN			BEGIN				SetPattern(pat^^);				HPurge(Handle(pat));			END		ELSE			SetPattern(black);		t := template^;		SetBorderFlags(t^.borderFlags);		SetPenSize(t^.borderPen.h, t^.borderPen.v);		IF ((t^.shadowPen.h > 0) & (t^.shadowPen.v > 0)) THEN			BEGIN				SetShadow(t^.shadowOffset.h, t^.shadowOffset.v, t^.shadowPen.h, t^.shadowPen.v);			END;		IF (BAND(borderFlags, kBorderRoundRect) <> 0) THEN			BEGIN				SetRounding(t^.roundDiameter.h, t^.roundDiameter.v);			END;		SetMargin(t^.margin);		Success;	END;(******************************************************************************}{ SetPattern}{}{ 	Set the pattern used for drawing all border parts.}{******************************************************************************)PROCEDURE CPaneBorder.SetPattern (aPattern: Pattern);	BEGIN		penPattern := aPattern;	END;(******************************************************************************}{ GetPattern}{}{ 	Return the current pattern.}{******************************************************************************)PROCEDURE CPaneBorder.GetPattern (VAR aPattern: Pattern);	BEGIN		aPattern := penPattern;	END;(******************************************************************************}{ SetBorderFlags}{}{ 	Set the border flags. The currently defined flags are:}{ 		}{		kBorderNone			0x00		no border}{		kBorderLeft			0x01		line on left side}{		kBorderTop			0x02		line on top side}{		kBorderRight		0x04		line on right side}{		kBorderBottom		0x08		line on bottom}{		kBorderOval			0x10		oval border}{		kBorderRoundRect	0x20		rounded rectangle border}{		kBorderRsrv1		0x40		reserved}{		kBorderRsrv2		0x80		reserved}{		}{	For convenience the constant kBorderFrame is defined to provide a}{	rectangular border. It is equivalent to specifying}{	kBorderLeft+kBorderTop+kBorderRight+kBorderBottom.}{}{******************************************************************************)PROCEDURE CPaneBorder.SetBorderFlags (aBorderFlags: Longint);	BEGIN		borderFlags := aBorderFlags;		(* Shadowing only applies to the kBorderFrame setting *)		IF (borderFlags <> kBorderFrame) THEN			doShadow := FALSE;	END;(******************************************************************************}{ GetBorderFlags}{}{ 	Return the current border flags}{******************************************************************************)FUNCTION CPaneBorder.GetBorderFlags: Longint;	BEGIN		GetBorderFlags := borderFlags;	END;(******************************************************************************}{ SetPenSize}{}{ 	Sert the pen size used to draw the border.}{******************************************************************************)PROCEDURE CPaneBorder.SetPenSize (penWidth: Integer;								penHeight: Integer);	BEGIN		SetPt(borderPen, penWidth, penHeight);	END;(******************************************************************************}{ GetPenSize}{}{ 	Return the pen size used to draw the border.}{******************************************************************************)PROCEDURE CPaneBorder.GetPenSize (VAR penWidth, penHeight: Integer);	BEGIN		penWidth := borderPen.h;		penHeight := borderPen.v;	END;(******************************************************************************}{ SetShadow}{}{ 	Set the shadow attributes. hOffset and vOffset specify the offset of the}{ 	shadow, i.e. how many pixels the shadow rectangle appears to be}{ 	offset from the pane frame. Width and height specify the pen size}{ 	used to draw the shadow.}{******************************************************************************)PROCEDURE CPaneBorder.SetShadow (hOffset: Integer;								vOffset: Integer;								width: Integer;								height: Integer);	BEGIN		SetBorderFlags(kBorderFrame);		doShadow := TRUE;		SetPt(shadowOffset, hOffset, vOffset);		SetPt(shadowPen, width, height);	END;(******************************************************************************}{ GetShadow}{ }{ 	Return the current shadow attributes.}{******************************************************************************)PROCEDURE CPaneBorder.GetShadow (VAR hOffset, vOffset, width, height: Integer);	BEGIN		hOffset := shadowOffset.h;		vOffset := shadowOffset.v;		width := shadowPen.h;		height := shadowPen.v;	END;(******************************************************************************}{ SetRounding}{}{ 	Set the rounding diameters. These are ultimately passed to FrameRoundRect.}{ 	Also sets the border style to kBorderRoundRect.}{******************************************************************************)PROCEDURE CPaneBorder.SetRounding (hDiameter, vDiameter: Integer);	BEGIN		SetBorderFlags(kBorderRoundRect);		SetPt(roundDiameter, hDiameter, vDiameter);	END;(******************************************************************************}{ GetRounding}{}{ 	Returns the current rounding diameters.}{******************************************************************************)PROCEDURE CPaneBorder.GetRounding (VAR hDiameter, vDiameter: Integer);	BEGIN		hDiameter := roundDiameter.h;		vDiameter := roundDiameter.v;	END;(******************************************************************************}{ SetMargin}{ }{ 	Set the margin rectangle. Each side of the margin rectangle specifies}{ 	the amount whitespace to add around the pane. All the sides should be}{ 	non-negative so that the border is outside the pane's frame.}{ 	For example, to have a one pixel thick black border and another}{ 	pixel of whitespace, specify a border with a width and height of 1, and}{ 	specify a 1 pixel margin. }{******************************************************************************)PROCEDURE CPaneBorder.SetMargin (aMargin: Rect);	BEGIN		margin := aMargin;	END;(******************************************************************************}{ GetMargin}{}{ 	Return the current border margin}{******************************************************************************)PROCEDURE CPaneBorder.GetMargin (VAR aMargin: Rect);	BEGIN		aMargin := margin;	END;(******************************************************************************}{ CalcBorderRect}{}{ 	Modify the given rectangle by expanding the sides as needed to accomodate}{ 	the border. The size of the border depends upon the currently specified }{ 	border attributes.}{******************************************************************************)PROCEDURE CPaneBorder.CalcBorderRect (VAR paneFrame: Rect);	VAR		exterior: Rect;	BEGIN		exterior := paneFrame;		exterior.left := exterior.left + margin.left;		exterior.top := exterior.top + margin.top;		exterior.right := exterior.right + margin.right;		exterior.bottom := exterior.bottom + margin.bottom;		IF (borderFlags = kBorderFrame) | (borderFlags = kBorderRoundRect) | (borderFlags = kBorderOval) THEN			BEGIN				exterior.left := exterior.left - borderPen.h;				exterior.right := exterior.right + borderPen.h;				exterior.top := exterior.top - borderPen.v;				exterior.bottom := exterior.bottom + borderPen.v;				IF (doShadow) THEN					BEGIN						exterior.right := exterior.right + shadowPen.h;						exterior.bottom := exterior.bottom + shadowPen.v;					END;			END		ELSE			BEGIN				IF (BAND(borderFlags, kBorderLeft) <> 0) THEN					exterior.left := exterior.left - borderPen.h;				IF (BAND(borderFlags, kBorderRight) <> 0) THEN					exterior.right := exterior.right + borderPen.h;				IF (BAND(borderFlags, kBorderTop) <> 0) THEN					exterior.top := exterior.top - borderPen.v;				IF (BAND(borderFlags, kBorderBottom) <> 0) THEN					exterior.bottom := exterior.bottom + borderPen.v;			END;		paneFrame := exterior;	END;(******************************************************************************}{ DrawBorder}{}{ 	Draw the border with paneFrame. Assumes the pane is already Prepared.}{******************************************************************************)PROCEDURE CPaneBorder.DrawBorder (paneFrame: Rect);	VAR		r: Rect;	BEGIN		r := paneFrame;		CalcBorderRect(r);		PenPat(penPattern);		PenSize(borderPen.h, borderPen.v);		IF (borderFlags = kBorderFrame) THEN			BEGIN				IF (doShadow) THEN					BEGIN						r.right := r.right - shadowPen.h;						r.bottom := r.bottom - shadowPen.v;						FrameRect(r);						PenSize(shadowPen.h, shadowPen.v);						MoveTo(r.left + shadowOffset.h, r.bottom);						LineTo(r.right, r.bottom);						MoveTo(r.right, r.top + shadowOffset.v);						LineTo(r.right, r.bottom);					END				ELSE					FrameRect(r);			END		ELSE IF (BAND(borderFlags, kBorderRoundRect) <> 0) THEN			FrameRoundRect(r, roundDiameter.h, roundDiameter.v)		ELSE IF (BAND(borderFlags, kBorderOval) <> 0) THEN			FrameOval(r)		ELSE			BEGIN				r.bottom := r.bottom - borderPen.v;				r.right := r.right - borderPen.h;				IF (BAND(borderFlags, kBorderTop) <> 0) THEN					BEGIN						MoveTo(r.left, r.top);						LineTo(r.right, r.top);					END;				IF (BAND(borderFlags, kBorderLeft) <> 0) THEN					BEGIN						MoveTo(r.left, r.top);						LineTo(r.left, r.bottom);					END;				IF (BAND(borderFlags, kBorderRight) <> 0) THEN					BEGIN						MoveTo(r.right, r.top);						LineTo(r.right, r.bottom);					END;				IF (BAND(borderFlags, kBorderBottom) <> 0) THEN					BEGIN						MoveTo(r.left, r.bottom);						LineTo(r.right, r.bottom);					END;			END;		PenNormal;	{ TCL 1.1.1 DLP 9/26/91 }	END;END.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      2¬      Â      Ø      ê      CPaneBorder.p   TEXTPJMM@       TEXTPJMM@                       ¤Vö      L  Ô      æ      ø      
            .      @      R      d      v      ˆ      ž      ´      Ê      à      ö         €   1.1.2	TCL 1.1.2           2 i’œü    2  vers   
 ÿÿ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            (******************************************************************************}{ CPanorama.p}{}{							The Panorama Class}{	}{	Abstract class for object which may have an extent which is larger}{	than what is visible on the screen. Typically, this means panes}{	that can be scrolled.}{	}{		}{	SUPERCLASS = CPane}{	}{	Copyright © 1989 Symantec Corporation. All rights reserved.}{	}{	TCL 1.1 CHANGES}{	[}{		- Changed interface for SetBounds, GetBounds, SetPosition, GetPosition,}{		  GetHomePosition, ScrollTo, SetBounds, and GetBounds }{		  to accomodate 32 bit coordinates.	}{		- implemented ClipToAperture method	 }{		- Because SetBounds takes a LongRect,  Panoramas can now have}{		  32-bit dimensions. If your Panorama subclass can ever extend beyond}{		  the normal QuickDraw 16-bit limit, then you should call}{		  UseLongCoordinates( TRUE) when you initialize it. When long}{		  coordinates are in use, you must convert your local Frame}{		  coordinates to QuickDraw coordinates before drawing. The}{		  methods FrameToQD and FrameToQDR can do this for you. }{	]}{}{ ******************************************************************************)UNIT CPanorama;INTERFACEUSES	TCL;IMPLEMENTATION(**** C O N S T R U C T I O N / D E S T R U C T I O N   M E T H O D S ****)(******************************************************************************}{ IPanorama}{}{		Initialize a Panorama object}{ ******************************************************************************)PROCEDURE CPanorama.IPanorama (anEnclosure: CView;								aSupervisor: CBureaucrat;								aWidth: Integer;								aHeight: Integer;								aHEncl: Integer;								aVEncl: Integer;								aHSizing: SizingOption;								aVSizing: SizingOption);	BEGIN		IPane(anEnclosure, aSupervisor, aWidth, aHeight, aHEncl, aVEncl, aHSizing, aVSizing);		printClip := clipPAGE;		bounds := frame;		position.h := bounds.left;		position.v := bounds.top;		hScale := 1;		vScale := 1;		itsScrollPane := NIL;	END;(******************************************************************************}{ IViewTemp {OVERRIDE}{Initialize a Panorama using a template }(******************************************************************************}PROCEDURE CPanorama.IViewTemp (anEnclosure: CView;			(* Enclosing view					*)								aSupervisor: CBureaucrat;	(* Boss in chain of command			*)								viewData: Ptr);				(* Template with View data			*)	VAR		p: PanoramaTempP;	BEGIN		p := PanoramaTempP(viewData);		{ Initialize superclass			}		INHERITED IViewTemp(anEnclosure, aSupervisor, @p^.sPaneTemp);										(* Set instance vars from template	*)		QDToLongRect(p^.bounds, bounds); { Set instance vars from template	}		hScale := p^.hScale;		vScale := p^.vScale;		QDToLongPt(p^.position, position);		itsScrollPane := NIL;	(**** A C C E S S I N G   M E T H O D S ****)	END;(******************************************************************************}{ GetExtent}{}{		Get the total horizontal and vertical size of the Panorama.}{		Subclasses can use any unit of size they wish.}{		For a graphics program, this could be the width and height of a}{		page in pixels. For a text program, this could be the pixel width}{		of a page and the number of lines in the document.}{		}{		This method uses the lengths of the sides of the bounds rectangle}{		as the extents. Subclasses must override this method if they}{		define their extents differently. An example is a very large}{		Panorama which uses a 32-bit coordinate system (QuickDraw rectangles}{		use only 16-bit values).}{ ******************************************************************************)PROCEDURE CPanorama.GetExtent (VAR theHExtent, theVExtent: Longint);	BEGIN		theHExtent := bounds.right - bounds.left;		theVExtent := bounds.bottom - bounds.top;	END;(******************************************************************************}{ GetFramePosition}{}{		Get the position of the top left corner of the frame with respect}{		to the entire panorama. That is, what portion of the panorama is}{		visible through its frame?}{		}{		This method uses the "position" instance variable. Subclasses should}{		override this method if they use a different means of monitoring}{		the frame postion. An example is a very large Panorama which uses}{		a 32-bit coordinate system (QuickDraw points use only 16-bit values).}{ ******************************************************************************)PROCEDURE CPanorama.GetFramePosition (VAR theHPos, theVPos: Longint);	BEGIN		theHPos := position.h - bounds.left;		theVPos := position.v - bounds.top;	END;(******************************************************************************}{ GetFrameSpan}{}{		Return the number of units (the same units as used when defining}{		the extent -- set GetExtent method) spanned by the frame of a}{		Panorama. This method assumes that units in each direction are of}{		constant size in pixels, as specified by the "hScale" and "vScale"}{		instance variables. Subclasses must override this method if they}{		use variable-sized units. An example is a spreadsheet which supports}{		variable-sized cells and uses a cell as a unit.}{ ******************************************************************************)PROCEDURE CPanorama.GetFrameSpan (VAR theHSpan, theVSpan: Integer);	BEGIN		(* Integer division truncates		*)		(*   We get the number of complete	*)		(*   units spanned by the frame		*)		theHSpan := width DIV hScale;		theVSpan := height DIV vScale;	END;(******************************************************************************}{ SetBounds}{}{		Set the bounds of the Panorama. The bounds define the overall}{		size of the data displayed by the Panorama and determine the}{		Pane coordinates. }{		}{ ******************************************************************************)PROCEDURE CPanorama.SetBounds (aBounds: LongRect);	BEGIN				(* Set instance variable			*)		bounds := aBounds;		IF (itsScrollPane <> NIL) THEN			itsScrollPane.AdjustScrollMax;	END;(******************************************************************************}{ GetBounds}{}{		Retrieve the bounds of the Panorama.}{ ******************************************************************************)PROCEDURE CPanorama.GetBounds (VAR theBounds: LongRect);	BEGIN					(* Pass back copy of instance var	*)		theBounds := bounds;	END;(* Set instance variable			*)(******************************************************************************}{ SetPosition}{}{		Set the position of the frame in relation to the Panorama. Position}{		specifies the location of the top left corner of the frame in}{		Pane coordinates.}{ ******************************************************************************)PROCEDURE CPanorama.SetPosition (aPosition: LongPt);	BEGIN							(* Pass back copy of instance var	*)		position := aPosition;		IF (itsScrollPane <> NIL) THEN			itsScrollPane.Calibrate;	END;(******************************************************************************}{ GetPosition}{}{		Retrieve the position of the frame in relation to the Panorama.}{ ******************************************************************************)PROCEDURE CPanorama.GetPosition (VAR thePos: LongPt);	BEGIN		thePos := position;	END;(******************************************************************************}{ SetScales}{}{		Set the horizontal and vertical scale factors. The scale factors}{		specify the number of pixels per Pane unit.}{ ******************************************************************************)PROCEDURE CPanorama.SetScales (aHScale, aVScale: Integer);	BEGIN		hScale := Max(aHScale, 1);		vScale := Max(aVScale, 1);		IF (itsScrollPane <> NIL) THEN			itsScrollPane.AdjustScrollMax;	END;(******************************************************************************}{ GetScales}{}{		Retrieve the horizontal and vertical scale factors.}{ ******************************************************************************)PROCEDURE CPanorama.GetScales (VAR theHScale, theVScale: Integer);	BEGIN							(* Return copies of instance vars	*)		theHScale := hScale;		theVScale := vScale;	END;(******************************************************************************}{ SetScrollPane}{}{		Specify a Scroll Pane for controlling a Panorama}{ ******************************************************************************)PROCEDURE CPanorama.SetScrollPane (aScrollPane: CScrollPane);	BEGIN								(* Set instance variable			*)		itsScrollPane := aScrollPane;	END;(******************************************************************************}{ GetHomePosition}{}{		Retrieve the location of the top left corner of the Panorama}{		in Pane coordinates. This method assumes that the bounds instance}{		variable defines the Pane coordinates.}{ ******************************************************************************)PROCEDURE CPanorama.GetHomePosition (VAR theHomePos: LongPt);	BEGIN		theHomePos := bounds.topLeft;	END;(******************************************************************************}{ GetPixelExtent {OVERRIDE}{Retrieve the dimensions of a Panorama in pixels . }{This method assumes that the bounds instance variable defines the size of the}{Panorama and that each unit has a constant size ( hScale horizontally and }{ vScale vertically ) . }(******************************************************************************}PROCEDURE CPanorama.GetPixelExtent (VAR hExtent, vExtent: Longint);	BEGIN		hExtent := (bounds.right - bounds.left) * hScale;		vExtent := (bounds.bottom - bounds.top) * vScale;	END;(**** C A L I B R A T I N G   M E T H O D S ****)(******************************************************************************}{ ResizeFrame {OVERRIDE}	{Adjust a Panorama 's frame when its size changes. The delta}	{rectangle parameter specifies the change in location of each side of the Pane}	{ Positive values mean a move to the right or down;}	{negative values mean a move to the left or up .}(******************************************************************************}PROCEDURE CPanorama.ResizeFrame (delta: Rect);	BEGIN						(* Adjust dimensions of the pane	*)		width := width + delta.right - delta.left;		height := height + delta.bottom - delta.top;		frame.left := frame.left + delta.left;						(* Shift edges by delta				*)		frame.top := frame.top + delta.top;		frame.right := frame.right + delta.right;		frame.bottom := frame.bottom + delta.bottom;						(* Scroll position is tied to the   *)						(* left of the frame.               *)		position.h := position.h + delta.left DIV hScale;		position.v := position.v + delta.top DIV vScale;		ForceNextPrepare;	END;(**** S C R O L L I N G   M E T H O D S ****)(******************************************************************************}{ Scroll}{}{		Scroll a Panorama within its frame by the specified number of}{		units in each direction. Units are Panorama-specific (see}{		GetExtent method). This method assumes that units are fixed in}{		size (hScale and vScale).}{ ******************************************************************************)PROCEDURE CPanorama.Scroll (hDelta: Longint;								vDelta: Longint;								redraw: Boolean);	VAR		hPixels: Longint;		vPixels: Longint;		tempRect: Rect;	PROCEDURE Pane_EnclosureScrolled (thePane: CPane);		BEGIN			thePane.EnclosureScrolled(hPixels, vPixels);		END;	BEGIN		hPixels := hDelta * hScale;		vPixels := vDelta * vScale;		IF (redraw) THEN			BEGIN					{ TCL 1.1.1 DLP 9/25/91 }					IF ((Abs(vPixels) < height) & (Abs(hPixels) < width)) THEN					BEGIN						Prepare;						FrameToQDR(aperture, tempRect);						ScrollRect(tempRect, -hPixels, -vPixels, gUtilRgn);						InvalRgn(gUtilRgn);					END				ELSE					Refresh;			END;		OffsetLongRect(frame, hPixels, vPixels);		OffsetLongRect(aperture, hPixels, vPixels);		position.h := position.h + hDelta;		position.v := position.v + vDelta;		hOrigin := hOrigin + hPixels;		vOrigin := vOrigin + vPixels;		ForceNextPrepare;		IF (itsSubviews <> NIL) THEN			itsSubviews.DoForEach(Pane_EnclosureScrolled);		IF (redraw) THEN			GetWindow.Update;	END;(******************************************************************************}{ ScrollTo}{}{		Scroll a Panorama so that the top left of its frame is at the}{		specified position}{ ******************************************************************************)PROCEDURE CPanorama.ScrollTo (aPosition: LongPt;								redraw: Boolean);	BEGIN		Scroll(aPosition.h - position.h, aPosition.v - position.v, redraw);		IF (itsScrollPane <> NIL) THEN			BEGIN				itsScrollPane.AdjustScrollMax;				itsScrollPane.Calibrate;			END;	END;(******************************************************************************}{ ScrollToSelection}{}{		Scroll a Panorama so that the current selection is visible within}{		the frame. Subclasses must override this method.}{ ******************************************************************************)PROCEDURE CPanorama.ScrollToSelection;	BEGIN		(* Null Method						*)	END;(* Mouse location in Frame coords	*)(******************************************************************************}{ AutoScroll}{}{		Automatically scroll a Panorama during mouse-down selecting.}{		Return value indicates whether or not scrolling occurred.}{ ******************************************************************************)FUNCTION CPanorama.AutoScroll (mouseLoc: LongPt): Boolean;	VAR		hDelta: Integer;		vDelta: Integer;		hSpan: Integer;		vSpan: Integer;		hStep: Integer;		vStep: Integer;	BEGIN		hDelta := 0;		vDelta := 0;		hStep := 1;		vStep := 1;		GetFrameSpan(hSpan, vSpan);		IF (itsScrollPane <> NIL) THEN			itsScrollPane.GetSteps(hStep, vStep);		IF (mouseLoc.h < frame.left) THEN			BEGIN				hDelta := Max(-hStep, bounds.left - position.h);				IF (hDelta > 0) THEN					hDelta := 0;			END		ELSE IF (mouseLoc.h > frame.right) THEN			BEGIN				hDelta := Min(hStep, bounds.right - position.h - hSpan);				IF (hDelta < 0) THEN					hDelta := 0;			END;		IF (mouseLoc.v < frame.top) THEN			BEGIN				vDelta := Max(-vStep, bounds.top - position.v);				IF (vDelta > 0) THEN					vDelta := 0;			END		ELSE IF (mouseLoc.v > frame.bottom) THEN			BEGIN				vDelta := Min(vStep, bounds.bottom - position.v - vSpan);				IF (vDelta < 0) THEN					BEGIN						vDelta := 0;					END;			END;		IF (hDelta <> 0) | (vDelta <> 0) THEN			BEGIN				Scroll(hDelta, vDelta, TRUE);				IF (itsScrollPane <> NIL) THEN					BEGIN						itsScrollPane.Calibrate;					END;				Prepare;				AutoScroll := TRUE;			END		ELSE			AutoScroll := FALSE;	END;(******************************************************************************}{ DoKeyDown  (OVERRIDE)}{}{        Implement Home, End, Page Up, and Page Down scrolling keys on}{        extended keyboards.}{ ******************************************************************************)PROCEDURE CPanorama.DoKeyDown (theChar: Char;								keyCode: Byte;								macEvent: EventRecord);	VAR		thePosition: LongPt;		theHExtent: Longint;		theVExtent: Longint;	BEGIN		CASE keyCode OF			KeyHome: 				IF (itsScrollPane <> NIL) THEN					BEGIN						GetHomePosition(thePosition);						ScrollTo(thePosition, TRUE);					END;			KeyEnd: 				IF (itsScrollPane <> NIL) THEN					BEGIN						GetExtent(theHExtent, theVExtent);						thePosition.h := Max(0, theHExtent - itsScrollPane.hSpan);						thePosition.v := Max(0, theVExtent - itsScrollPane.vSpan);						ScrollTo(thePosition, TRUE);					END;			KeyPageUp: 				IF (itsScrollPane <> NIL) THEN					BEGIN						itsScrollPane.DoVertScroll(inPageUp);						itsScrollPane.AdjustScrollMax;					END;			KeyPageDown: 				IF (itsScrollPane <> NIL) THEN					BEGIN						itsScrollPane.DoVertScroll(inPageDown);						itsScrollPane.AdjustScrollMax;					END;			OTHERWISE				INHERITED DoKeyDown(theChar, keyCode, macEvent);		END;	END;(**** P R I N T I N G   M E T H O D S ****)(******************************************************************************}{ Paginate {OVERRIDE}{Determine how many pages to print .}{For pagination purpose , the panorama is divided into horizontal and vertical strips of pages . The size of each strip may be}{set separately . The default is to divide the extent into equal size strips . }(******************************************************************************}PROCEDURE CPanorama.Paginate (aPrinter: CPrinter;								pageWidth: Integer;								pageHeight: Integer);	VAR		pixWidth: Longint;		pixHeight: Longint;		hStrips: Integer;		vStrips: Integer;	BEGIN					(* Get the full extent of the panorama		*)		GetPixelExtent(pixWidth, pixHeight);					(* determine how many horizontal and 		*)					(* vertical strips are required				*)		hStrips := pixWidth DIV pageWidth + 1;		vStrips := pixHeight DIV pageHeight + 1;					(* tell the printer how many strips, strips	*)					(* are initially set to page width and		*)					(* height									*)		aPrinter.SetStrips(hStrips, vStrips);		aPrinter.SetAllStripWidths(pageWidth);		aPrinter.SetAllStripHeights(pageHeight);	END;(******************************************************************************}{ AboutToPrint {OVERRIDE}{    The specified range of pages is about to be printed .}(******************************************************************************}PROCEDURE CPanorama.AboutToPrint (VAR firstPage, lastPage: Integer);	BEGIN							(* Save current position since it	*)							(*   may have to be changed during	*)							(*   the print loop					*)		savePosition := position;		INHERITED AboutToPrint(firstPage, lastPage);	END;(******************************************************************************}{ PrintPage {OVERRIDE}{Print the specified page .}(******************************************************************************}PROCEDURE CPanorama.PrintPage (pageNum: Integer; (* Number of the page to print		*)								pageWidth: Integer;	(* Width of printed page in pixels	*)								pageHeight: Integer;	(* Height of page in pixels			*)								aPrinter: CPrinter);	VAR		savePort: GrafPtr;		area: LongRect;		qdArea: Rect;		scrollPos: LongPt;	BEGIN		aPrinter.GetPageArea(pageNum, area);		(* scroll to the start of the page	*)		GetPort(savePort);		scrollPos := area.topLeft;		scrollPos.h := scrollPos.h DIV hScale;		scrollPos.v := scrollPos.v DIV vScale;		ScrollTo(scrollPos, FALSE);		SetPort(savePort);		(* setup class variable cPageArea with portion of page to be printed *)		FrameToWindR(area, cPageArea);		ForceNextPrepare;		Prepare;		FrameToWindR(area, qdArea);		DrawAll(qdArea);		SetRect(cPageArea, 0, 0, 0, 0);	END;(******************************************************************************}{ DonePrinting {OVERRIDE}{Print loop has been completed . Perform any necessary clean - up .}(******************************************************************************}PROCEDURE CPanorama.DonePrinting;	VAR		savePos: LongPt;	BEGIN		savePos := savePosition;		INHERITED DonePrinting;		IF (NOT EqualLongPt(savePos, position)) THEN			BEGIN				ScrollTo(savePos, FALSE);			END;	END;END.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       2Ú      È      „      ž      CPanorama.p   TEXTPJMM@         TEXTPJMM@                       ¤WL	      L        ž      à      è      ü                  6      >      F      J      R      Z      b      j      r         €   1.1.2	TCL 1.1.2           2 i’œü    2  vers   
 ÿÿ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            (******************************************************************************}{ CPicture.p}{}{							The Picture Class}{}{		Displays a standard Toolbox "picture".}{}{	SUPERCLASS = CPanorama}{}{	Copyright © 1989 Symantec Corporation. All rights reserved.}{}{	TCL 1.1 CHANGES}{	[}{		- Added exception handling}{		- Dispose only disposes of the picture if it is not a resource.}{	]}{ ******************************************************************************)UNIT CPicture;INTERFACEUSES	TCL;IMPLEMENTATION(******************************************************************************}{ IPicture}{}{		Initialize a Picture object}{ ******************************************************************************)PROCEDURE CPicture.IPicture (anEnclosure: CView;								aSupervisor: CBureaucrat;								aWidth: Integer;								aHeight: Integer;								aHEncl: Integer;								aVEncl: Integer;								aHSizing: SizingOption;								aVSizing: SizingOption);	BEGIN		IPanorama(anEnclosure, aSupervisor, aWidth, aHeight, aHEncl, aVEncl, aHSizing, aVSizing);		macPicture := NIL;		scaled := FALSE;		autoRefresh := scaled;		isResPicture := FALSE;		ownsPicture := FALSE;	END;(******************************************************************************}{ IViewTemp {OVERRIDE}	{Initialize a Picture object using a template }(******************************************************************************}PROCEDURE CPicture.IViewTemp (anEnclosure: CView;			(* Enclosing view					*)								aSupervisor: CBureaucrat;	(* Boss in chain of command			*)								viewData: Ptr);				(* Template with View data			*)	VAR		p: PictureTempP;	BEGIN		p := PictureTempP(viewData);		INHERITED IViewTemp(anEnclosure, aSupervisor, @p^.sPanoramaTemp);		scaled := p^.scaled <> 0;		autoRefresh := scaled;		IF (p^.PICTid <> NOTHING) THEN			BEGIN				UsePICT(p^.PICTid);			END		ELSE			BEGIN				macPicture := NIL;			END;(* Set instance vars from template	*)	END;(******************************************************************************}{ Free  (OVERRIDE)}{}{        Dispose of a Picture object}{ ******************************************************************************)PROCEDURE CPicture.Free;	BEGIN		IF (macPicture <> NIL) & ownsPicture THEN			BEGIN				IF (isResPicture) THEN					HPurge(Handle(macPicture))				ELSE					KillPicture(macPicture);			END;		macPicture := NIL;		INHERITED Free;	END;(******************************************************************************}{ Draw {OVERRIDE}		{ Draw a Picture}(******************************************************************************}PROCEDURE CPicture.Draw (VAR area: Rect);	VAR		tempRect: Rect;		savedAlloc: Boolean;		savedState: SignedByte;	BEGIN		IF (macPicture = NIL) THEN			BEGIN				LongToQDRect(aperture, tempRect);				EraseRect(tempRect);			END		ELSE			BEGIN				IF (isResPicture) THEN					BEGIN						savedAlloc := SetAllocation(kAllocCanFail);						LoadResource(Handle(macPicture));						savedAlloc := SetAllocation(savedAlloc);						FailResError;						savedState := HGetState(Handle(macPicture));						HNoPurge(Handle(macPicture));					END;				IF (scaled) THEN					BEGIN						LongToQDRect(frame, tempRect);						DrawPicture(macPicture, tempRect);					END				ELSE					BEGIN						LongToQDRect(bounds, tempRect);						DrawPicture(macPicture, tempRect);					END;				IF (isResPicture) THEN					HSetState(Handle(macPicture), savedState);			END;	END;(******************************************************************************}{ SetMacPicture}{}{	Specify a new PicHandle for a Picture. ownsPicture is set to true, unless}{	the picture is from a purgeable resource. ownsPicture determines whether the}{	picture is disposed or purged when the CPicture object is disposed.}{ ******************************************************************************)PROCEDURE CPicture.SetMacPicture (aMacPicture: PicHandle);	VAR		resID: Integer;		aResType: ResType;		resName: Str255;		newBounds: LongRect;		purgeable: Boolean;	BEGIN		macPicture := aMacPicture;		IF (macPicture <> NIL) THEN			BEGIN				ownsPicture := TRUE;				QDToLongRect(macPicture^^.picFrame, newBounds);				OffsetLongRect(newBounds, -newBounds.left, -newBounds.top);				(* determine if this picture is from a resource		*)				GetResInfo(Handle(macPicture), resID, aResType, resName);				isResPicture := ResError = noErr;				IF (isResPicture) THEN					BEGIN						purgeable := BAND(GetResAttrs(Handle(macPicture)), resPurgeable) <> 0;						IF (purgeable) THEN							ownsPicture := FALSE;					END				ELSE					HNoPurge(Handle(macPicture));			END		ELSE			BEGIN				SetLongRect(newBounds, 0, 0, 0, 0);				ownsPicture := FALSE;			END;		SetBounds(newBounds);	END;(******************************************************************************}{ GetMacPicture}{}{		Retrieve the PicHandle for a Picture}{ ******************************************************************************)FUNCTION CPicture.GetMacPicture: PicHandle;	BEGIN					(* Return instance variable			*)		GetMacPicture := macPicture;	END;(******************************************************************************}{ UsePICT}{}{		Use a new picture specified by a PICT resource id}{ ******************************************************************************)PROCEDURE CPicture.UsePICT (PICTid: Integer);	VAR		pict: PicHandle;		savedAlloc: Boolean;	BEGIN		savedAlloc := SetAllocation(kAllocCanFail);		pict := GetPicture(PICTid);		savedAlloc := SetAllocation(savedAlloc);		FailNILRes(pict);		SetMacPicture(pict);	END;(******************************************************************************}{ SetScaled}{}{		Set the scaled flag which controls whether the picture is scaled}{		to the frame of the pane or drawn at its natural size}{ ******************************************************************************)PROCEDURE CPicture.SetScaled (aScaled: Boolean);	VAR		pBounds: LongRect;	BEGIN		scaled := aScaled;		IF (scaled) THEN			BEGIN								(* Boundaries are the same as frame	*)								(*   left of the frame				*)				position.h := frame.left;				position.v := frame.top;				SetBounds(frame);			END		ELSE							(* Display picture at normal size	*)			BEGIN			(* Top left of picture is at top	*)			(* Put top left of bounds at (0, 0)	*)			(*   top left may have moved		*)			(*   only when it is scaled			*)				QDToLongRect(macPicture^^.picFrame, pBounds);				OffsetLongRect(pBounds, -pBounds.left, -pBounds.top);				SetBounds(pBounds);								(* Need to reposition picture since	*)								(* Size of frame affects picture	*)				SetPosition(position);			END;		autoRefresh := scaled;	END;(******************************************************************************}{ GetScaled}{}{		Return whether or not a Picture is scaled}{ ******************************************************************************)FUNCTION CPicture.GetScaled: Boolean;	BEGIN								(* Return instance variable			*)		GetScaled := scaled;	END;(******************************************************************************}{ ResizeFrame {OVERRIDE}	{Adjust a Pictures 's frame when the size of the pane changes. The delta}	{rectangle parameter specifies the change in location of each side of the Pane .}	{ Positive values mean a move to the right or down;}	{negative values mean a move to the left or up .}	{ After using the inherited method, we have to reset the bounds if the }	{picture is scaled to the frame .}(******************************************************************************}PROCEDURE CPicture.ResizeFrame (delta: Rect);	BEGIN		INHERITED ResizeFrame(delta);		IF (scaled) THEN			SetBounds(frame);	END;(******************************************************************************}{ FrameToBounds}{}{		Make the frame of the Picture the same size as the bounds}{ ******************************************************************************)PROCEDURE CPicture.FrameToBounds;	BEGIN		frame := bounds;		width := frame.right - frame.left;		height := frame.bottom - frame.top;	END;END.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          (******************************************************************************}{ CPrinter.p}{}{							The Printer Class}{	}{	SUPERCLASS = CObject}{	}{	Copyright © 1989 Symantec Corporation. All rights reserved.}{}{	TCL 1.1 CHANGES}{		- implemented ClosePrintMgr, SetPrintDir, HavePagination, ResetPagination,}{		  SetStrips, SetHorizPageBreak, SetVertPageBreak, SetAllStripWidths,}{		  SetStripHeight, SetAllStripHeights, GetStripCount, PageNumToStrips,}{		  GetPageStart, GetPageArea methods}{	] }{}{ ******************************************************************************)UNIT CPrinter;INTERFACEUSES	TCL;IMPLEMENTATIONUSES	PrintTraps;(**** C O N S T R U C T I O N / D E S T R U C T I O N   M E T H O D S ****)(******************************************************************************}{ IPrinter}{}{		Initialize a Printer object. Printer can be passed a handle to}{		an existing Toolbox print recordl. If handle is NULL, a new}{		print record with default values is created.}{		}{		Boolean result indicates whether the print record passed as a}{		parameter was changed because it was incompatible with the}{		currently installed printer. This allows documents which associate}{		a printer record with a file to update itself if desired.}{ ******************************************************************************)FUNCTION CPrinter.IPrinter (aDocument: CDocument;								aMacTPrint: Handle): Boolean;	VAR		changed, ignore: Boolean;		err: Integer;		runArray: CRunArray;	BEGIN		changed := FALSE;		savedResFile := -1;		printDocOpen := FALSE;		printPageOpen := FALSE;		macPrintPort := NIL;		printMgrOpen := FALSE;		ignore := OpenPrintMgr(FALSE);		IF (PrError = noErr) THEN			BEGIN				IF (aMacTPrint = NIL) THEN					BEGIN						aMacTPrint := NewHandleCanFail(SIZEOF(TPrint));						FailNIL(aMacTPrint);						PrintDefault(THPrint(aMacTPrint)); (* Set default print record values	*)					END				ELSE					BEGIN					(* Check validity of existing		*)						changed := PrValidate(THPrint(aMacTPrint));		(*}{		 * If an error occured in PrintDefault or PrValidate we want}{		 * to inform the user, but we don't want to signal failure. }{		 * Therefore we check the error and if needed, call ErrorAlert.}{		 *)					END;				err := PrError;				IF (err <> noErr) THEN					ErrorAlert(err, 0);			END;		ClosePrintMgr;		itsDocument := aDocument;		macTPrint := aMacTPrint;		printDirection := printVert;		NEW(runArray);		itsStripWidths := runArray;		itsStripWidths.IRunArray;		NEW(runArray);		itsStripHeights := runArray;		itsStripHeights.IRunArray;		IPrinter := changed;	END;(******************************************************************************}{ Free {OVERRIDE}	{Dispose of a Printer object. The Toolbox print record is thrown out also , even}     	{if it was passed a valid handle in the IPrinter method .}(******************************************************************************}PROCEDURE CPrinter.Free;	BEGIN		ForgetHandle(macTPrint);		(* Throw out Toolbox print record	*)		ForgetObject(itsStripWidths);		ForgetObject(itsStripHeights);		INHERITED Free;	(* Pass message on to superclass	*)	END;(******************************************************************************}{ OpenPrintMgr}{}{		Prepare the Mac Printing Manager by opening its driver and resource}{		file. An error here usually means that the user has not selected}{		a printer from the Chooser or does not have the proper drivers in}{		the System folder. This method notifies the user with an Alert in}{		such a case.}{ ******************************************************************************)FUNCTION CPrinter.OpenPrintMgr (fCheckFailure: Boolean): Boolean;	VAR		itemHit: Integer;	BEGIN		ASSERT(NOT printMgrOpen);		savedResFile := CurResFile;		printMgrOpen := TRUE;		PrOpen;		IF (fCheckFailure & (PrError <> noErr)) THEN			BEGIN				PositionDialog('ALRT', ALRT_NOPRINTER);				itemHit := StopAlert(ALRT_NOPRINTER, NIL);				OpenPrintMgr := FALSE;			END		ELSE			BEGIN				OpenPrintMgr := TRUE;			END;	END;(******************************************************************************}{ ClosePrintMgr}{}{	Close the print mgr, balancing out any other PrintMgr open calls that}{	were made.}{ ******************************************************************************)PROCEDURE CPrinter.ClosePrintMgr;	BEGIN		IF (printMgrOpen) THEN			BEGIN				IF (printDocOpen) THEN					BEGIN						IF (printPageOpen) THEN							BEGIN								printPageOpen := FALSE;								PrClosePage(TPPrPort(macPrintPort));							END;						printDocOpen := FALSE;						PrCloseDoc(TPPrPort(macPrintPort));					END;				printMgrOpen := FALSE;				macPrintPort := NIL;				PrClose;				IF (savedResFile <> -1) THEN					BEGIN						UseResFile(savedResFile);						savedResFile := -1;					END;			END;	END;(******************************************************************************}{ GetPrintRecord}{}{		Returns a handle to the Toolbox print record associated with}{		a Printer object. Other objects should treat this record as}{		read-only. Note that this method calls PrValidate before}{		returning the print record. This is important because the user}{		could have picked another printer via the Chooser since the}{		last time PrValidate was called.}{ ******************************************************************************)FUNCTION CPrinter.GetPrintRecord: Handle;	VAR		ok: Boolean;	BEGIN										(* Open the printer driver			*)		ok := OpenPrintMgr(TRUE);		IF ok & (PrError = noErr) THEN			BEGIN										(* Check validity of print record	*)				ok := PrValidate(THPrint(macTPrint));				FailOSErr(PrError);			END;										(* Close the printer driver			*)		ClosePrintMgr;		GetPrintRecord := macTPrint;		(* Return instance variable			*)	END;(******************************************************************************}{ GetPageInfo}{}{		Returns information about the paper size and printable area of}{		the paper. This info is required for setting accurate margins.}{		The paper and page rectangles are specified in dots. The hRes and}{		vRes values indicate the number of dots per inch. Thus dividing}{		the width of the paperRect by hRes gives the width of the}{		paper in inches.}{		}{		Note that this method calls PrValidate before returning the print}{		record. This is important because the user could have picked another}{		printer via the Chooser since the last time PrValidate was called.}{		}{		This method extracts the pertinent information from the print record.}{		The programmer could also use the GetPrintRecord command and}{		access the information directly.}{ ******************************************************************************)PROCEDURE CPrinter.GetPageInfo (VAR paperRect, (* The physical paper size			*)								pageRect: Rect; 		(* Printable area of the page		*)								VAR hRes, 				(* Horizontal resolution			*)								vRes: Integer);			(* Vertical resolution				*)	VAR		recPtr: TPPrint;		(* Deference of print record handle	*)		ignore: Boolean;	BEGIN							(* Open the printer driver			*)		ignore := OpenPrintMgr(FALSE);		IF (PrError = noErr) THEN			BEGIN									(* Check validity of print record	*)				ignore := PrValidate(THPrint(macTPrint));				FailOSErr(PrError);			END;		ClosePrintMgr;					(* Close the printer driver			*)		IF (macTPrint <> NIL) THEN		(* Extract info from print record	*)			BEGIN				recPtr := THPrint(macTPrint)^;				paperRect := recPtr^.rPaper;				pageRect := recPtr^.prInfo.rPage;				hRes := recPtr^.prInfo.iHRes;				vRes := recPtr^.prInfo.iVRes;			END		ELSE		(* There is no print record			*)			BEGIN				SetRect(paperRect, 0, 0, 0, 0);				pageRect := paperRect;				hRes := 0;				vRes := 0;			END;	END;(******************************************************************************}{ DoPageSetup}{}{		Respond to the Page Setup command by displaying the standard}{		Toolbox printer style dialog, which allows the user to set}{		the page dimensions and other goodies.}{		}{		Boolean result indicates whether the user pressed OK to confirm}{		possible changes in the print record. This allows documents which}{		associate a printer record with a file to update itself if desired.}{ ******************************************************************************)FUNCTION CPrinter.DoPageSetup: Boolean;	VAR		changed: Boolean;	(* Has print record changed?		*)	BEGIN		changed := FALSE;		IF (OpenPrintMgr(TRUE)) THEN	(* Open printer driver				*)			BEGIN							(* Toolbox trap posts the dialog	*)				changed := PrStlDialog(THPrint(macTPrint));				FailOSErr(PrError);			END;				(* Close the printer driver			*)		ClosePrintMgr;		IF (changed) THEN			ResetPagination;		DoPageSetup := (changed);	END;(******************************************************************************}{ DoPrint}{}{		Respond to the Print command by displaying the standard printer}{		job dialog. Then print the associated Document if the user}{		confirms the print request.}{ ******************************************************************************)PROCEDURE CPrinter.DoPrint;	VAR		wantsToPrint: Boolean;	BEGIN		wantsToPrint := FALSE;						(* Open printer driver				*)		IF (OpenPrintMgr(TRUE)) THEN			BEGIN				wantsToPrint := PrJobDialog(THPrint(macTPrint));				FailOSErr(PrError);			END;						(* Close the printer driver			*)		ClosePrintMgr;		IF (wantsToPrint) THEN			BEGIN				SetCursor(gWatchCursor^^);				PrintPageRange(THPrint(macTPrint)^^.prJob.iFstPage, THPrint(macTPrint)^^.prJob.iLstPage);			END;	END;(******************************************************************************}{ PrintPageRange}{}{		Print the specified range of pages. Normally, this message is}{		sent by the DoPrint method after the user clicks "OK" for the Job}{		Dialog. Programs may send this message on their own, but bypassing}{		the standard dialogs is highly discouraged (see TechNote 122).}{ ******************************************************************************)PROCEDURE CPrinter.PrintPageRange (firstPage, lastPage: Integer);									{ TCL 1.1.1 DLP 10/28/91 }	VAR		printStatus: TPrStatus;		page: Integer;		lastError: Integer;		fi: FailInfo;	PROCEDURE HandleFailure (error: Integer;									message: Longint);		BEGIN			ClosePrintMgr;			itsDocument.DonePrinting;		END;	BEGIN		CatchFailures(fi, HandleFailure);		itsDocument.AboutToPrint(firstPage, lastPage);		IF (OpenPrintMgr(TRUE)) THEN			BEGIN				IF (PrValidate(THPrint(macTPrint))) THEN					ResetPagination;			END;		ClosePrintMgr;		IF NOT HavePagination THEN		{ TCL 1.1.1 DLP 9/25/91 }			BEGIN				itsDocument.Paginate;				IF NOT HavePagination THEN					EXIT(PrintPageRange);			END;		IF (OpenPrintMgr(TRUE)) THEN			BEGIN				THPrint(macTPrint)^^.prJob.iFstPage := 1;				THPrint(macTPrint)^^.prJob.iLstPage := lastPage - firstPage + 1;				printDocOpen := TRUE;				macPrintPort := GrafPtr(PrOpenDoc(THPrint(macTPrint), NIL, NIL));				FOR page := firstPage TO lastPage DO					BEGIN						IF (PrError = noErr) THEN							BEGIN								printPageOpen := TRUE;								PrOpenPage(TPPrPort(macPrintPort), NIL);								IF (PrError = noErr) THEN									BEGIN										itsDocument.PrintPageOfDoc(page);									END;								printPageOpen := FALSE;								PrClosePage(TPPrPort(macPrintPort));							END;					END;				printDocOpen := FALSE;				PrCloseDoc(TPPrPort(macPrintPort));				macPrintPort := NIL;				IF (THPrint(macTPrint)^^.prJob.bJDocLoop = bSpoolLoop) & (PrError = noErr) THEN					BEGIN						PrPicFile(THPrint(macTPrint), NIL, NIL, NIL, printStatus);					END;							(* Print error before PrClose		*)				lastError := PrError;							(* Don't report error if the user	*)							(*   aborted the printing			*)				IF (lastError <> iPrAbort) THEN					BEGIN						FailOSErr(lastError);					END;			END;		Success;					(* Close the printer driver			*)		ClosePrintMgr;					(* Reset error code to what it was	*)					(*   before closing printer in case	*)					(*   Document needs it				*)		PrSetError(lastError);		itsDocument.DonePrinting;	END;(******************************************************************************}{ SetPrintDir}{ }{ 	Set the direction of printing when there is more than one}{ 	horizontal and vertical strip.}{ 	}{ ******************************************************************************)PROCEDURE CPrinter.SetPrintDir (aPrintDir: tPrintDirection);	BEGIN		printDirection := aPrintDir;	END;(******************************************************************************}{ ResetPagination}{ }{ 	Clear any current pagination, setting the number of horizontal and vertical}{ 	strips to zero.}{ ******************************************************************************)PROCEDURE CPrinter.ResetPagination;	BEGIN		itsStripWidths.DeleteAll;		itsStripHeights.DeleteAll;	END;(******************************************************************************}{ HavePagination}{ }{ 	Return true if there is any horizontal and vertical pagination info}{ ******************************************************************************)FUNCTION CPrinter.HavePagination: Boolean;	VAR		haveHPage: Boolean;		haveVPage: Boolean;	BEGIN		haveHPage := (itsStripWidths <> NIL) & (itsStripWidths.GetNumItems > 0);		haveVPage := (itsStripHeights <> NIL) & (itsStripHeights.GetNumItems > 0);		HavePagination := haveHPage & haveVPage;	END;(******************************************************************************}{ SetStrips}{ }{ 	}{ ******************************************************************************)PROCEDURE CPrinter.SetStrips (numHStrips, numVStrips: Integer);	VAR		printRec: THPrint;		pageRect: Rect;	BEGIN		ResetPagination;		printRec := THPrint(GetPrintRecord);		ASSERT(printRec <> NIL);		IF (printRec <> NIL) THEN			BEGIN				pageRect := printRec^^.prInfo.rPage;				itsStripWidths.InsertValue(1, pageRect.right - pageRect.left, numHStrips);				itsStripHeights.InsertValue(1, pageRect.bottom - pageRect.top, numVStrips);			END;	END;(******************************************************************************}{ SetHorizPageBreak}{ }{ 	Set a page break at a horizontal position in a client's Frame coordinates}{ ******************************************************************************)PROCEDURE CPrinter.SetHorizPageBreak (vStripNum: Integer;								hPos: Longint);	VAR		prevBreak: Longint;	BEGIN		ASSERT((vStripNum >= 1) & (vStripNum <= itsStripWidths.GetNumItems + 1));		prevBreak := itsStripWidths.SumRange(1, vStripNum - 1);		SetStripWidth(vStripNum, hPos - prevBreak);	END;(******************************************************************************}{ SetVertPageBreak}{ }{ 	Set a page break at a vertical position in a client's Frame coordinates}{ ******************************************************************************)PROCEDURE CPrinter.SetVertPageBreak (hStripNum: Integer;								vPos: Longint);	VAR		prevBreak: Longint;	BEGIN		ASSERT((hStripNum >= 1) & (hStripNum <= itsStripHeights.GetNumItems + 1));		prevBreak := itsStripHeights.SumRange(1, hStripNum - 1);		SetStripHeight(hStripNum, vPos - prevBreak);	END;(******************************************************************************}{ SetAllStripWidths}{ }{ 	Sets the width all vertical page strips.}{ ******************************************************************************)PROCEDURE CPrinter.SetAllStripWidths (aStripWidth: Integer);	VAR		numStrips: Integer;	BEGIN		numStrips := itsStripWidths.GetNumItems;		itsStripWidths.DeleteAll;		itsStripWidths.InsertValue(1, aStripWidth, numStrips);	END;(* must have some pixels on a page	*)(******************************************************************************}{ SetStripWidth}{ }{ 	Sets the width of one vertical page strip}{ ******************************************************************************)PROCEDURE CPrinter.SetStripWidth (pageNum: Integer;								aStripWidth: Integer);	BEGIN		ASSERT(aStripWidth > 0);		IF (pageNum <= itsStripWidths.GetNumItems) THEN			itsStripWidths.SetValue(pageNum, aStripWidth)		ELSE			itsStripWidths.InsertValue(pageNum, aStripWidth, 1);	END;(******************************************************************************}{ SetAllStripHeights}{ }{ 	Sets the height of all horizontal page strips}{ ******************************************************************************)PROCEDURE CPrinter.SetAllStripHeights (aStripHeight: Integer);	VAR		numStrips: Integer;	BEGIN		numStrips := itsStripHeights.GetNumItems;		itsStripHeights.DeleteAll;		itsStripHeights.InsertValue(1, aStripHeight, numStrips);	END;(******************************************************************************}{ SetStripHeight}{ }{ 	Sets the height of one horizontal page strip.}{ ******************************************************************************)PROCEDURE CPrinter.SetStripHeight (pageNum, aStripHeight: Integer);	BEGIN						(* must have some pixels on a page	*)		ASSERT(aStripHeight > 0);		IF (pageNum <= itsStripHeights.GetNumItems) THEN			itsStripHeights.SetValue(pageNum, aStripHeight)		ELSE			itsStripHeights.InsertValue(pageNum, aStripHeight, 1);	END;(******************************************************************************}{ GetStripCount}{ }{ 	Return the number of horizontal and vertical page strips}{ ******************************************************************************)PROCEDURE CPrinter.GetStripCount (VAR hStrips, vStrips: Integer);	BEGIN		IF (itsStripHeights <> NIL) THEN			hStrips := itsStripHeights.GetNumItems		ELSE			hStrips := 0;		IF (itsStripWidths <> NIL) THEN			vStrips := itsStripWidths.GetNumItems		ELSE			vStrips := 0;	END;(******************************************************************************}{ PageNumToStrips}{ }{ 	Given a page number, return the corresponding strip numbers}{ ******************************************************************************)PROCEDURE CPrinter.PageNumToStrips (pageNum: Integer;								VAR hStrip, vStrip: Integer);	VAR		hStrips: Integer;		vStrips: Integer;	BEGIN		ASSERT(HavePagination);		hStrips := itsStripHeights.GetNumItems;		vStrips := itsStripWidths.GetNumItems;		ASSERT(pageNum <= hStrips * vStrips);		IF (printDirection = printHoriz) THEN			BEGIN				hStrip := (pageNum - 1) DIV vStrips + 1;				vStrip := (pageNum - 1) MOD vStrips + 1;			END		ELSE			BEGIN				vStrip := (pageNum - 1) DIV hStrips + 1;				hStrip := (pageNum - 1) MOD hStrips + 1;			END;	END;(******************************************************************************}{ GetPageStart}{ }{ 	Get the starting position of a page in the Frame coordinates of a client.}{ ******************************************************************************)PROCEDURE CPrinter.GetPageStart (pageNum: Integer;								VAR startPos: LongPt);	VAR		theHStrip: Integer;		theVStrip: Integer;	BEGIN		PageNumToStrips(pageNum, theHStrip, theVStrip);		startPos.h := itsStripWidths.SumRange(1, theVStrip - 1);		startPos.v := itsStripHeights.SumRange(1, theHStrip - 1);	END;(******************************************************************************}{ GetPageArea}{ }{ ******************************************************************************)PROCEDURE CPrinter.GetPageArea (pageNum: Integer;								VAR pageArea: LongRect);	VAR		theHStrip: Integer;		theVStrip: Integer;	BEGIN		PageNumToStrips(pageNum, theHStrip, theVStrip);		GetPageStart(pageNum, pageArea.topLeft);		pageArea.right := pageArea.left + itsStripWidths.GetValue(theVStrip);		pageArea.bottom := pageArea.top + itsStripHeights.GetValue(theHStrip);	END;END.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              2h      n      t      z      
CPrinter.p    TEXTPJMM@         TEXTPJMM@                       ¤Vˆ      L  ¼      Â      È      Î      Ô      Ü      à      è      ð      ô                   $      J      v      Š         €   1.1.2	TCL 1.1.2           2 i’œü    2  vers   
 ÿÿ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            