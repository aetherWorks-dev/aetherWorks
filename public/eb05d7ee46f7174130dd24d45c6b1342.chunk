{****************************************************}{ 		CFWDesktop.p}{}{		The FWDesktop Class}{}{		A Desktop which support floating windows. Floating windows are}{		always active and remain above all "regular" windows.}{}{		SUPERCLASS = CDesktop}{}{		Copyright © 1989, Symantec Corporation.  All rights reserved.			}{}{****************************************************}UNIT CFWDesktop;INTERFACEUSES	SysEqu, TCL, FW_Tearoffs, CWindow;IMPLEMENTATION{** Class Constant **}CONST	NO_DRAG = $80008000; 		{ Flag signalling an aborted drag	}{****************************************************}{ IFWDesktop}{}{		Initialize a FWDesktop object}{}{****************************************************}PROCEDURE CFWDesktop.IFWDesktop (aSupervisor: CBureaucrat);	VAR		theFloats: CList;	BEGIN		IDesktop(aSupervisor);		{ Initialize superclass			}		new(theFloats);             { Initialize our list of floating   windows }		itsFloats := theFloats;		itsFloats.IList;		topFloat := NIL;	END;{****************************************************}{ Free (OVERRIDE)}{}{		Dispose of a FWDesktop}{}{****************************************************}PROCEDURE CFWDesktop.Free;	BEGIN		itsFloats.DisposeAll;			{ Get rid of floating				}		itsWindows.DisposeAll;		{   and regular windows			}		ClosePort(macPort);				{ Throw out QuickDraw port and all	}		DisposPtr(Ptr(macPort));		{   assocated data structures		}		INHERITED Free;				{ Pass message on to superclass	}	END;{****************************************************}{ AdjustCursor (OVERRIDE)}{}{		Mouse is located where no other object wants to set the cursor shape.}{		Adjust the shape to the standard arrow cursor}{}{****************************************************}PROCEDURE Window_DiffContRgn (theWindow: CWindow;								mouseRgn: RgnHandle);			{Subtract content region of floating window from mouseRgn}	BEGIN		IF theWindow.IsVisible THEN			BEGIN	{ TCL 1.1.1 DLP 9/25/91 }				UnionRgn(mouseRgn, WindowPeek(theWindow.GetMacPort)^.strucRgn, mouseRgn);				DiffRgn(mouseRgn, WindowPeek(theWindow.GetMacPort)^.contRgn, mouseRgn);			END;	END;PROCEDURE CFWDesktop.AdjustCursor (where: Point;								mouseRgn: RgnHandle);	BEGIN		INHERITED AdjustCursor(where, mouseRgn);		IF topFloat <> NIL THEN			itsFloats.DoForEach1(Window_DiffContRgn, mouseRgn); { TCL 1.1.1 DLP 9/26/91 }	END;{****************************************************}{ AddWind (OVERRIDE)}{}{		Add a window to the desktop}{}{****************************************************}PROCEDURE CFWDesktop.AddWind (theWindow: CWindow);	BEGIN		IF theWindow.IsFloating THEN			itsFloats.Prepend(theWindow)		ELSE			itsWindows.Add(theWindow);	END;{****************************************************}{ RemoveWind (OVERRIDE)}{}{		Remove a window from the desktop}{}{****************************************************}PROCEDURE CFWDesktop.RemoveWind (theWindow: CWindow);	BEGIN		IF theWindow.IsVisible THEN			HideWind(theWindow);				{ Hide window before discarding it	}		IF theWindow.IsFloating THEN			itsFloats.Remove(theWindow)		ELSE			itsWindows.Remove(theWindow);	END;{****************************************************}{ SelectWind (OVERRIDE)}{}{		Select a window by bringing it to the front and making it active}{}{****************************************************}PROCEDURE CFWDesktop.SelectWind (theWindow: CWindow);	VAR		aDAIsActive: Boolean;			{ TRUE if a DA is the front window	}		aWindow: CWindow;			{ Window object						}		oldTop: CWindow;				{ Former top regular window		}		macWPtr: WindowPtr;			{ Ptr to Toolbox window record		}		theDA: WindowPtr;				{ Ptr to window record for a DA	}	BEGIN										{ Check if a DA is running			}		aDAIsActive := IsSystemWindow(WindowPeek(FrontWindow));										{ Do nothing if the window is at	}										{   the top of its layer and a DA	}										{   is not active					}		IF ((theWindow = topWindow) OR (theWindow = topFloat)) AND NOT aDAIsActive THEN			Exit(SelectWind)		ELSE			BEGIN				IF aDAIsActive THEN					BEGIN					{ A DA is currently running. Need	}									{   to activate our application.		}									{ Find our bottom-most window		}						aWindow := GetBottomWindow;						IF aWindow = NIL THEN							macWPtr := NIL						ELSE							macWPtr := aWindow.macPort;										{ Put all DAs behind our bottom	}										{   window, maintaining the		}										{   ordering of the DAs			}						theDA := FrontWindow;						WHILE (IsSystemWindow(WindowPeek(theDA))) DO							BEGIN								SendBehind(theDA, macWPtr);								macWPtr := theDA;								theDA := FrontWindow;							END;					END;				IF theWindow.IsFloating THEN					BEGIN						{ Select a floating window		}						IF theWindow <> topFloat THEN							BEGIN					{ If this isn't the top float ...		}										{   Make it the front window		}								BringToFront(theWindow.macPort);										{   Update our window list		}								itsFloats.BringFront(theWindow);								theWindow.Show;			{   Make it visible, if necessary	}								topFloat := theWindow;	{   Mark it as the top float		}							END;					END				ELSE IF theWindow <> topWindow THEN					BEGIN										{ If this isn't the top regular...	}						oldTop := topWindow;	{   Save the current top regular	}						aWindow := CWindow(itsFloats.LastItem);						IF aWindow = NIL THEN										{   Put it in front if there are	}										{     no floating windows			}							BringToFront(theWindow.macPort)						ELSE										{   Otherwise, put it behind the	}										{     bottom floating window		}							BringBehind(theWindow.macPort, aWindow.macPort);										{   Update our window list		}						itsWindows.BringFront(theWindow);						theWindow.ShowOrHide(TRUE);		{   Make it visible, if necessary	}						topWindow := theWindow;			{   Mark it as the top regular	}						IF aDAIsActive THEN							BEGIN								IF oldTop <> NIL THEN									BEGIN										HiliteWindow(oldTop.macPort, FALSE);										CDirector(oldTop.itsSupervisor).active := FALSE;									END;								CDirector(topWindow.itsSupervisor).active := TRUE;							END						ELSE							BEGIN								IF oldTop <> NIL THEN 		{   Deactivate the former top	}												{     regular window				}									oldTop.Deactivate;								topWindow.Activate;		{   Activate the new top window	}							END;					END;				LongPtr(CurActivate)^ := longint(NIL);	 { Nuke any pending activate event	}			END;	END;{****************************************************}{ ShowWind (OVERRIDE)}{}{		Make a window visible on the desktop}{}{****************************************************}PROCEDURE CFWDesktop.ShowWind (theWindow: CWindow);	BEGIN		IF theWindow.IsFloating THEN			BEGIN				ShowHide(theWindow.macPort, TRUE);				theWindow.Activate;				CalcTopFloat;			END		ELSE			INHERITED ShowWind(theWindow);	END;{****************************************************}{ HideWind (OVERRIDE)}{}{		Make a window invisible on the desktop}{}{****************************************************}PROCEDURE CFWDesktop.HideWind (theWindow: CWindow);	BEGIN		IF theWindow.IsFloating THEN			BEGIN				ShowHide(theWindow.macPort, FALSE);				IF theWindow = topFloat THEN					CalcTopFloat;			END		ELSE			INHERITED HideWind(theWindow);	END;{****************************************************}{ DragWind (OVERRIDE)}{}{		Drag a window on the desktop}{}{****************************************************}PROCEDURE CFWDesktop.DragWind (theWindow: CWindow;								macEvent: EventRecord);	VAR		savePort: GrafPtr;				{ The current QD port				}		macWindow: WindowPtr;		{ Toolbox window pointer			}		corner: Point;					{ Top left corner of window			}		dragBox: Rect;					{ Where window may be dragged	}		newLoc: longint;				{ New location after drag			}		hDrag: integer;					{ Distance dragged horizontally		}		vDrag: integer;					{ Distance dragged vertically		}	BEGIN		IF (theWindow <> topWindow) AND (theWindow <> topFloat) AND (BAND(macEvent.modifiers, cmdKey) = 0) THEN										{ Drag for an underlying window	}										{   without the command key being	}										{   pressed. Select window before	}										{   performing the drag.				}			SelectWind(theWindow);		IF NOT StillDown THEN 			{ Take a quick exit if the mouse	}			Exit(DragWind);				{   has already been released	}		GetPort(savePort);				{ Save the current port			}										{ Find Global coords of the top	}										{   left corner of the window	}		macWindow := WindowPtr(theWindow.GetMacPort);		SetPort(macWindow);		corner := topLeft(macWindow^.portRect);		LocalToGlobal(corner);		SetPort(macPort);				{ Use desktop's port					}		PenNormal;						{ Use standard pen characteristics	}		dragBox := bounds;				{ Don't allow drag too close to	}										{   the edge of the screen		}		InsetRect(dragBox, DRAG_MARGIN, DRAG_MARGIN);										{ Drag dotted outline of window	}		CopyRgn(WindowPeek(macWindow)^.strucRgn, gUtilRgn);		newLoc := DragGrayRgn(gUtilRgn, macEvent.where, dragBox, dragBox, 0, NIL);		hDrag := LoWord(newLoc);		vDrag := HiWord(newLoc);										{ If a drag actually occurred, put	}										{   window at new location			}		IF (newLoc <> NO_DRAG) AND ((hDrag <> 0) OR (vDrag <> 0)) THEN			MoveWindow(macWindow, LoWord(newLoc) + corner.h, HiWord(newLoc) + corner.v, FALSE);		SetPort(savePort);				{ Restore the original port			}	END;{****************************************************}{ Show (OVERRIDE)}{}{		Make a Desktop visible by showing all its windows}{}{****************************************************}PROCEDURE CFWDesktop.Show;	BEGIN		IF NOT visible THEN			BEGIN						{ Do nothing if already visible	}				visible := TRUE;				itsFloats.DoForEach(Window_Show);				itsWindows.DoForEach(Window_Show);			END;	END;{****************************************************}{ Hide (OVERRIDE)}{}{		Make a Desktop invisible by hiding all its windows}{}{****************************************************}PROCEDURE CFWDesktop.Hide;	BEGIN		IF visible THEN			BEGIN						{ Do nothing if already invisible	}				visible := FALSE;				itsWindows.DoForEach(Window_Hide);				itsFloats.DoForEach(Window_Hide);			END;	END;{****************************************************}{ Activate (OVERRIDE)}{}{		Activate a desktop by activating all floating windows and the}{		top regular window}{}{****************************************************}PROCEDURE CFWDesktop.Activate;	BEGIN		IF NOT active THEN			BEGIN						{ Do nothing if already active		}				active := TRUE;				itsFloats.DoForEach(Window_Activate);				IF topWindow <> NIL THEN					topWindow.Activate;			END;	END;{****************************************************}{ Deactivate (OVERRIDE)}{}{		Deactivate a desktop by deactivating all floating windows and the}{		top regular window}{}{****************************************************}PROCEDURE CFWDesktop.Deactivate;	BEGIN		IF active THEN			BEGIN						{ Do nothing if already inactive	}				active := FALSE;				itsFloats.DoForEach(Window_Deactivate);				IF topWindow <> NIL THEN					topWindow.Deactivate;			END;	END;{****************************************************}{ GetBottomWindow (OVERRIDE)}{}{		Return the Desktop's bottom-most window (not including DAs).}{}{****************************************************}FUNCTION CFWDesktop.GetBottomWindow: CWindow;	VAR		bottomWindow: CWindow;	BEGIN		bottomWindow := INHERITED GetBottomWindow;		IF bottomWindow = NIL THEN			GetBottomWindow := CWindow(itsFloats.LastItem)		ELSE			GetBottomWindow := bottomWindow;	END;{****************************************************}{ CalcTopFloat}{}{		Set topFloat to the first visible window in itsFloats (if any). }{}{****************************************************}PROCEDURE CFWDesktop.CalcTopFloat;	BEGIN		topFloat := CWindow(itsFloats.FirstSuccess(Window_IsVisible));	END;{****************************************************}{ Cleanup (OVERRIDE)}{}{		Move THINK Pascal's windows behind our application's windows. }{}{		If we are running in the THINK Pascal environment, one or more }{		of THINK Pascal's windows may (from our viewpoint) "suddenly" }{		appear directly behind our top floating window.  This happens if }{		the user clicks on a Pascal window, or if the user breaks into the }{		source-level debugger, opens up some windows, and resumes }{		execution.  In these situations, THINK Pascal takes care of bringing }{		our frontmost (floating) window back to the top }{		(when CApplication.Run calls FrontWindow), but we are }{		responsible for bringing the rest of our floating windows and our }{		top non-floating window forward.  If we are NOT running in the }{		THINK Pascal environment, this code will have no ill effects. }{}{****************************************************}PROCEDURE CFWDesktop.Cleanup;	VAR		testWindow, bottomFloat, lastWindowMoved: WindowPeek;	BEGIN{ No cleanup necessary if there are no floating windows. }		IF itsFloats.FirstItem <> NIL THEN		{ We use itsFloats.FirstItem instead }												{ of topFloat because if topFloat = nil, }												{ that means there are no VISIBLE }												{ floating windows;  there still may be }												{ an invisible floating window, which }												{ THINK Pascal would consider our }												{ application's frontmost window. }			BEGIN				lastWindowMoved := NIL;	{ We will use this var to preserve the ordering }										{ of the Pascal windows. }				IF topWindow <> NIL THEN{ If there are THINK Pascal windows behind the top floating window, }{ then send the Pascal windows behind the top non-floating window }{ (topWindow). }					REPEAT						testWindow := WindowPeek(CWindow(itsFloats.FirstItem).GetMacPort)^.nextWindow;						IF testWindow^.windowKind >= pascalKind THEN							BEGIN								IF lastWindowMoved = NIL THEN									SendBehind(WindowPtr(testWindow), topWindow.macPort)								ELSE									SendBehind(WindowPtr(testWindow), WindowPtr(lastWindowMoved));								lastWindowMoved := testWindow;							END;					UNTIL testWindow^.windowKind < pascalKind				ELSE{ There are no visible non-floating windows.  If there are THINK Pascal windows }{ behind the top floating window, then send the }{ Pascal windows behind the bottom floating window. }					BEGIN						bottomFloat := WindowPeek(CWindow(itsFloats.LastItem).GetMacPort);						IF itsFloats.FirstItem <> itsFloats.LastItem THEN							REPEAT								testWindow := WindowPeek(CWindow(itsFloats.FirstItem).GetMacPort)^.nextWindow;								IF testWindow^.windowKind >= pascalKind THEN									BEGIN										IF lastWindowMoved = NIL THEN											SendBehind(WindowPtr(testWindow), WindowPtr(bottomFloat))										ELSE											SendBehind(WindowPtr(testWindow), WindowPtr(lastWindowMoved));										lastWindowMoved := testWindow;									END;							UNTIL testWindow^.windowKind < pascalKind;					END;			END;	END;END.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             2 ç    'ÿÿ     'ÿÿ k    CFWDesktop.pt   TEXTPJMM@       TEXTPJMM@                       ¢p_¤      Lõ MCD ÿÿ <    '4  MB¤'9 	H    '> 	j    'C	Š MBœ'K 	š    'Z	ª    'e 	º    'x 	Ì    'Š 	Þ    'Ø›   €   1.1.2	TCL 1.1.2           2 i’œü    2  vers   
 ÿÿ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            {****************************************************}{ 		CGridSelector.p}{}{		The GridSelector Class}{}{		A rectangular grid of items from which a single selection may}{		be made.}{}{		SUPERCLASS = CSelector}{}{		Copyright © 1989, Symantec Corporation.  All rights reserved.			}{}{****************************************************}UNIT CGridSelector;INTERFACEUSES	TCL, FW_Tearoffs;IMPLEMENTATION{****************************************************}{ IGridSelector}{}{		Initialize a GridSelector object}{}{****************************************************}PROCEDURE CGridSelector.IGridSelector (anEnclosure: CView;								aSupervisor: CBureaucrat;								aHEncl, aVEncl: integer;								aHSizing, aVSizing: SizingOption;								aSelection, aCommandBase, aRows, aColumns, aBoxWidth, aBoxHeight: integer);	VAR		aWidth: integer;		aHeight: integer;	BEGIN		aWidth := aColumns * aBoxWidth - 1;		aHeight := aRows * aBoxHeight - 1;		gridOn := TRUE;		rows := aRows;		columns := aColumns;		boxWidth := aBoxWidth;		boxHeight := aBoxHeight;		ISelector(anEnclosure, aSupervisor, aWidth, aHeight, aHEncl, aVEncl, aHSizing, aVSizing, rows * columns, aSelection, aCommandBase);		autoRefresh := FALSE;		position.h := 1;		position.v := 1;		bounds.left := 1;		bounds.top := 1;		bounds.right := columns + 1;		bounds.bottom := rows + 1;		SetScales(boxWidth, boxHeight);	END;{****************************************************}{ Draw (OVERRIDE)}{}{		Draw a Grid Selector}{}{****************************************************}PROCEDURE CGridSelector.Draw (VAR area: Rect);	VAR		r: integer;					{ Row index				}		c: integer;					{ Column index			}		theItem: integer;			{ Item number				}		theBox: Rect;				{ Bounding box of item	}	BEGIN		IF gridOn THEN				{ Draw grid lines between items	}			DrawGrid;		theItem := 0;					{ Run thru and draw all items		}		FOR r := 1 TO rows DO			FOR c := 1 TO columns DO				BEGIN					theItem := theItem + 1;					FindItemBox(theItem, theBox);					DrawItem(theItem, theBox);				END;		IF active THEN							{ Hilite the current selection		}			HiliteItem(selection, hiliteON);	END;{****************************************************}{ HiliteItem (OVERRIDE)}{}{		Hilite an item in the specified way}{}{****************************************************}PROCEDURE CGridSelector.HiliteItem (theItem: integer;								state: HiliteState);	VAR		theRect: Rect;		theBox: Rect;		ticks: longint;	BEGIN		IF theItem = NOTHING THEN			Exit(HiliteItem);		theBox := theRect;		FindItemBox(theItem, theBox);		CASE state OF			hiliteON, hiliteOFF: 				InvertRect(theBox);			hiliteDYNAMIC: 				BEGIN					PenNormal;					PenMode(patXor);					FrameRect(theBox);					Delay(2, ticks);					InsetRect(theBox, 1, 1);					FrameRect(theBox);					Delay(2, ticks);					FrameRect(theBox);					Delay(2, ticks);					InsetRect(theBox, -1, -1);					FrameRect(theBox);					PenNormal;				END;		END;	END;{****************************************************}{ FindItem (OVERRIDE)}{}{		Determine which item, if any, is selected by a click at the}{		specified hit point. Point is specified in pane coordinates.}{}{****************************************************}FUNCTION CGridSelector.FindItem (hitPt: Point): integer;	VAR		theRow: integer;		theCol: integer;	BEGIN		theRow := (hitPt.v - 1) DIV boxHeight + 1;		theCol := (hitPt.h - 1) DIV boxWidth + 1;		IF (theRow < 1) OR (theRow > rows) OR (theCol < 1) OR (theCol > columns) THEN			FindItem := NOTHING		ELSE			FindItem := (theRow - 1) * columns + theCol;	END;{****************************************************}{ FindItemBox}{}{		Return the enclosing box of a particular item. Note that the}{		enclosing box does not include the surrounding grid lines.}{}{****************************************************}PROCEDURE CGridSelector.FindItemBox (theItem: integer;								VAR theBox: Rect);	VAR		theRow, theCol, extra: integer;	BEGIN		IF gridOn THEN			extra := -1		ELSE			extra := 0;		SetRect(theBox, 0, 0, boxWidth + extra, boxHeight + extra);		theRow := (theItem - 1) DIV columns + 1;		theCol := (theItem - 1) MOD columns + 1;		OffsetRect(theBox, (theCol - 1) * boxWidth, (theRow - 1) * boxHeight);	END;{****************************************************}{ DrawGrid}{}{		Draw grid lines around the items}{}{****************************************************}PROCEDURE CGridSelector.DrawGrid;	VAR		coord, length: integer;	BEGIN		length := width - 1;		coord := boxHeight - 1;		WHILE coord <= height DO			BEGIN				MoveTo(0, coord);				LineTo(length, coord);				coord := coord + boxHeight;			END;		length := height - 1;		coord := boxWidth - 1;		WHILE coord <= width DO			BEGIN				MoveTo(coord, 0);				LineTo(coord, length);				coord := coord + boxWidth;			END;	END;{****************************************************}{ DrawItem}{}{		Draw an item within the specified box. Subclasses must override}{		this method.}{}{****************************************************}PROCEDURE CGridSelector.DrawItem (theItem: integer;								theBox: Rect);	BEGIN	END;										{ Null Method						}{****************************************************}{ SetGridOn}{}{		Turn the drawing of grid lines on or off}{}{****************************************************}PROCEDURE CGridSelector.SetGridOn (aGridOn: Boolean);	BEGIN		gridOn := aGridOn;					{ Set instance variable			}	END;END.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      {****************************************************}{ 		CMenuDefProc.p}{}{		The MenuDefProc Class}{}{		Abstract class for a "Menu Definition Procedure". Not really a}{		single procedure, but a class with methods corresponding to each}{		of the actions the Toolbox can request of a menu.}{}{		SUPERCLASS = CObject}{}{		Copyright © 1989, Symantec Corporation.  All rights reserved.			}{}{****************************************************}UNIT CMenuDefProc;INTERFACEUSES	TCL, FW_Tearoffs;IMPLEMENTATION{****************************************************}{ IMenuDefProc}{}{		Initialize a MenuDefProc object}{}{****************************************************}PROCEDURE CMenuDefProc.IMenuDefProc (MDEFid: integer);	VAR		theMDEF: GenericMDEFHand;		theMDEFP: GenericMDEFPtr;	BEGIN		theMDEF := GenericMDEFHand(GetResource('MDEF', MDEFid));		FailNILRes(theMDEF);		theMDEFP := theMDEF^;		theMDEFP^.defProc := @GenericMDEF;		theMDEFP^.itsMenuDefProc := SELF;		FlushCache;	{ TCL 1.1.1 DLP 9/26/91 }					{ Flush the CPU cache because we just modified code }	END;{****************************************************}{ DrawMenu}{}{		Draw the contents of the menu. Subclasses must override this}{		method.}{}{****************************************************}PROCEDURE CMenuDefProc.DrawMenu (macMenu: MenuHandle;								menuRect: Rect);	BEGIN	END;										{ Null Method						}{****************************************************}{ ChooseItem}{}{		Determine which item in the menu is hit. Subclasses which support}{		selection of items from the menu must override this method.}{}{****************************************************}PROCEDURE CMenuDefProc.ChooseItem (macMenu: MenuHandle;								menuRect: Rect;								hitPt: Point;								VAR whichItem: integer);	BEGIN		whichItem := NOTHING;	END;{****************************************************}{ SizeMenu}{}{		Determine the height and width of the menu in pixels. Subclasses}{		must override this method.}{}{****************************************************}PROCEDURE CMenuDefProc.SizeMenu (macMenu: MenuHandle);	VAR		macMenuP: MenuPtr;	BEGIN		macMenuP := macMenu^;		macMenuP^.menuWidth := 0;		macMenuP^.menuHeight := 0;	END;{****************************************************}{ PlacePopup}{}{		Determine the placement of a pop-up menu. Subclasses must override}{		this method if they wish to support pop-up menus.}{}{****************************************************}PROCEDURE CMenuDefProc.PlacePopup (macMenu: MenuHandle;								menuRect: Rect;								hitPt: Point;								VAR whichItem: integer);	BEGIN	END;										{ Null Method						}END.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      2( Ý _Î    (é _ô    (ý `CMenuDefProc.pC   TEXTPJMM@     TEXTPJMM@                        N×–      Lj an    'ÿÿa¨ MB„'ÿÿÿ b    (ÿÿ c     (ÿÿ c¦    ( ÿÿ d,    'üÿÿ dÊ    (ÿÿ eP    'þÿÿ g    'ÿÿ h    (ÿÿ h†       €   1.1.2	TCL 1.1.2           2 i’œü    2  vers   
 ÿÿ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            (******************************************************************************}{ CPaneMDEF.c}{}{							The PaneMDEF Class}{							}{	A menu definition procedure which treats the menu contents as a pane.}{	Thus any pane which can be draw in a window can also be displayed in}{	a menu. Also includes some support for tear-off menus.}{			}{	SUPERCLASS = CMenuDefProc}{	}{	Copyright © 1989 Symantec Corporation. All rights reserved.}{}{	Change History:}{		01/30/90	pb	Added SetupQuickDraw and RestoreQuickDraw methods.}{}{ ******************************************************************************)unit CPaneMDEF;interface	uses		FW_Tearoffs;implementation	uses		Script;	const		TEARMARGIN = 10;	(* Margin for tearing off a menu	*)		TEARWAIT = 6;		(* Ticks to delay while dragging	*)		FRAME_WIDTH = 1;	(* Thickness of window frame		*)		DRAG_WIDTH = 10;	(* Thickness of window drag bar		*)(******************************************************************************}{ IPaneMDEF}{}{		Initialize a PaneMDEF object}{ ******************************************************************************)	procedure CPaneMDEF.IPaneMDEF (MDEFid: Integer; aPane: CPane; aTearOffMenu: CTearOffMenu);	begin		(* Initialize superclass			*)		inherited IMenuDefProc(MDEFid);		itsPane := aPane;		itsTearOffMenu := aTearOffMenu;	end;(******************************************************************************}{ DrawMenu [OVERRIDE]}{}{		Draw the contents of the pane which will appear in the menu.}{		Drawing is performed in the Desktop's port.}{ ******************************************************************************)	procedure CPaneMDEF.DrawMenu (macMenu: MenuHandle; menuRect: Rect);		var			paneFrame: LongRect;	(* Frame of pane to be drawn		*)			qdFrame: Rect;	begin		SetupQuickDraw(menuRect);		itsPane.GetFrame(paneFrame);		(* Set up pane's drawing environs	*)		LongToQDRect(paneFrame, qdFrame);	(* Draw pane inside the menu		*)		itsPane.RestoreEnvironment;		itsPane.Draw(qdFrame);	(* Check if the entire menu is disabled.  If so, the menu	*)	(* should be drawn in gray. We draw in gray by BIC'ing		*)	(* a gray pattern over the entire pane.						*)		if not MenuEnabled(macMenu) then			begin				PenMode(patBic);			(* ??? Should selections be			*)				PenPat(gray);				(*     unhilited?					*)				PaintRect(qdFrame);			end;		RestoreQuickDraw;	end;(******************************************************************************}{ SizeMenu [OVERRIDE]}{}{		Determine the height and width of the menu in pixels. Size of the}{		menu is the same as that of the pane's frame.}{ ******************************************************************************)	procedure CPaneMDEF.SizeMenu (macMenu: MenuHandle);		var			width, height: Integer;	begin	(* Get dimensions of its pane		*)		itsPane.GetLengths(width, height);		macMenu^^.menuWidth := width;		macMenu^^.menuHeight := height;	end;(******************************************************************************}{ TearOffMenu}{}{		Drag dotted outline of torn off menu}{ ******************************************************************************)	procedure CPaneMDEF.TearOffMenu (menuRect: Rect;	(* Bounding box of menu				*)									mouseLoc: Point);								(* Mouse location					*)		var			margins: Rect;			(* Margins around menu rectangle	*)			tearRect: Rect;		(* Current location of tear off		*)			grayPat: Pattern;		(* Gray pattern for dragging		*)			ticks: Longint;		(* Tick count after delay			*)	begin	(* Tear off occurs only when the	*)	(*   mouse is in certain places		*)		if PtInTearRgn(mouseLoc, menuRect) then			begin								(* Prepare to tear off the menu		*)								(*   by dragging a gray outline		*)								(*   of the menu					*)				PenNormal;				PenPat(gray);				PenMode(patXor);		(* Toggle gray rect on the screen	*)				SetClip(GetGrayRgn);				itsTearOffMenu.GetMargins(margins);				repeat							(* Seize control until the mouse	*)							(*   is released or leaves the		*)							(*   valid tear off region			*)							(* Make a rectangle which is the	*)							(*   same size as the window which	*)							(*   holds the tear off menu		*)					tearRect.left := menuRect.left - margins.left;					tearRect.top := menuRect.top - margins.top;					tearRect.right := menuRect.right + margins.right;					tearRect.bottom := menuRect.bottom + margins.bottom;					OffsetRect(tearRect, mouseLoc.h - menuRect.left, mouseLoc.v - menuRect.top);							(* Drawing and then undrawing a gray outline at *)							(* the current location gives the illlusion of	*)							(* dragging the tear off menu					*)					FrameRect(tearRect);			(* Draw the gray outline			*)					Delay(TEARWAIT, ticks);			(* Wait a while						*)					FrameRect(tearRect);			(* Undraw the gray outline			*)					GetMouse(mouseLoc);				(* Check current mouse location		*)				until not (StillDown & PtInTearRgn(mouseLoc, menuRect));				PenNormal;							(* Restore normal pen state			*)			(* Check reason for loop exit		*)			(*   region							*)				if (PtInTearRgn(mouseLoc, menuRect)) then					begin			(* Mouse released inside tear off	*)						itsTearOffMenu.TornOff(mouseLoc);					end;			end;	end;(******************************************************************************}{ PtInTearRgn}{}{		Check if a point is in a region where menu may be torn off}{ ******************************************************************************)	function CPaneMDEF.PtInTearRgn (hitPt: Point;	(* Mouse location					*)									menuRect: Rect): Boolean;					(* Bounding box of menu				*)	begin		(* Valid tear off region:  Mouse is not in the menu bar and   *)		(* at least TEARMARGIN pixels from the left, right, or bottom *)		(* sides of the menu.										  *)		PtInTearRgn := ((hitPt.v > GetMBarHeight) & ((hitPt.h < menuRect.left - TEARMARGIN) | (hitPt.h > menuRect.right + TEARMARGIN) | (hitPt.v > menuRect.bottom + TEARMARGIN)));	end;(******************************************************************************}{ SetupQuickDraw}{}{		Set up QuickDraw drawing environment so pane coordinates work.}{ ******************************************************************************)	procedure CPaneMDEF.SetupQuickDraw (menuRect: Rect);		var			tsaveClip: RgnHandle;			newOrigin: Point;			(* New origin for pane				*)			desktopBounds: Rect;		(* Boundaries of the desktop		*)			paneFrame: LongRect;			qdFrame: Rect;	begin		GetPort(savePort);			(* Save the current port			*)		gDesktop.Prepare;			(* Draw into our Desktop's port		*)		itsPane.GetFrame(paneFrame);	(* Get size of pane and Desktop		*)		LongToQDRect(paneFrame, qdFrame);		gDesktop.GetBounds(desktopBounds);		tsaveClip := NewRgn;		(* Save clipping region of Desktop	*)		GetClip(tsaveClip);		saveClip := tsaveClip;								(* Pane will be drawn in Desktop's	*)								(*   port rather than its own, so	*)								(*   we must adjust the pane's		*)								(*   origin accordingly				*)		newOrigin.h := paneFrame.left - menuRect.left + desktopBounds.left;		newOrigin.v := paneFrame.top - menuRect.top + desktopBounds.top;		SetOrigin(newOrigin.h, newOrigin.v);								(* Pane's frame corresponds to the	*)								(*   menu rectangle, so make sure	*)								(*   we don't draw outside the menu	*)		ClipRect(qdFrame);		cPreparedView := itsPane;	end;(******************************************************************************}{ RestoreQuickDraw}{}{		Restore QuickDraw drawing environment to saved values.}{ ******************************************************************************)	procedure CPaneMDEF.RestoreQuickDraw;		var			desktopBounds: Rect;	begin			(* Restore origin and clipping		*)			(*   region of our desktop			*)		gDesktop.GetBounds(desktopBounds);		SetOrigin(desktopBounds.left, desktopBounds.top);		SetClip(saveClip);		DisposeRgn(saveClip);		SetPort(savePort);		cPreparedView := nil;	end;end.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          {****************************************************}{ 		CPatternGrid.p}{}{		The PatternGrid Class}{}{		SUPERCLASS = CGridSelector}{}{		Copyright © 1989, Symantec Corporation.  All rights reserved.			}{}{****************************************************}unit CPatternGrid;interface	uses		TCL, FW_Tearoffs;	type		PtGdRec = record		{ Resource template for a pattern grid	}				rows, cols, boxWidth, boxHeight, hSizing, vSizing, hLoc, vLoc, commandBase, patListID, numPats: integer;				thePatterns: array[0..1000] of integer;			end;		PtGdPtr = ^PtGdRec;		PtGdHand = ^PtGdPtr;implementation{*** C O N S T R U C T I O N / D E S T R U C T I O N   M E T H O D S ***}{****************************************************}{ IPatternGrid}{}{		Initialize a PatternGrid object}{}{****************************************************}	procedure CPatternGrid.IPatternGrid (PtGdid: integer; anEnclosure: CView; aSupervisor: CBureaucrat);		var			r: PtGdHand;			p: PtGdPtr;	begin		r := PtGdHand(GetResource('PtGd', PtGdid));		FailNILRes(r);		HLock(Handle(r));		p := r^;		IGridSelector(anEnclosure, aSupervisor, p^.hLoc, p^.vLoc, SizingOption(p^.hSizing), SizingOption(p^.vSizing), 1, p^.commandBase, p^.rows, p^.cols, p^.boxWidth, p^.boxHeight);		patListID := p^.patListID;		numPats := p^.numPats;		thePatterns := IntArrayH(NewHandle(numPats * sizeof(integer)));		BlockMove(@p^.thePatterns, @thePatterns^^, Size(numPats * sizeof(integer)));		HUnlock(Handle(r));	end;{****************************************************}{ Free (OVERRIDE)}{}{		Dispose of a pattern grid}{}{****************************************************}	procedure CPatternGrid.Free;	begin		DisposHandle(Handle(thePatterns));	{ Get rid of list of pattern ID's		}		inherited Free;							{ Pass message on to superclass	}	end;{****************************************************}{ DrawItem}{}{		Draw the pattern at the specified row and column}{}{****************************************************}	procedure CPatternGrid.DrawItem (theItem: integer; theBox: Rect);		var			thePat: Pattern;	begin		GetIndPattern(thePat, patListID, thePatterns^^[theItem - 1]);		FillRect(theBox, thePat);	end;{****************************************************}{ HiliteItem (OVERRIDE)}{}{		Hilite an item in the specified way}{}{****************************************************}	procedure CPatternGrid.HiliteItem (theItem: integer; state: HiliteState);		var			theBox: Rect;			ticks: longint;			hBox: Rect;	begin		if theItem = NOTHING then			Exit(HiliteItem);		FindItemBox(theItem, theBox);		case state of			hiliteON: 				begin					hBox := theBox;					InsetRect(hBox, -4, -4);					PenMode(patCopy);					PenPat(white);					PenSize(3, 3);					FrameRect(hBox);					InsetRect(hBox, -1, -1);					PenNormal;					FrameRect(hBox);				end;			hiliteOFF: 				begin					hBox := theBox;					InsetRect(hBox, -5, -5);					RefreshRect(hBox);				end;			hiliteDYNAMIC: 				begin					PenNormal;					PenMode(patXor);					FrameRect(theBox);					Delay(2, ticks);					InsetRect(theBox, 1, 1);					FrameRect(theBox);					Delay(2, ticks);					FrameRect(theBox);					Delay(2, ticks);					InsetRect(theBox, -1, -1);					FrameRect(theBox);					PenNormal;				end;		end;	end;{****************************************************}{ GetPattern}{}{		Return the currently selected pattern}{}{****************************************************}	procedure CPatternGrid.GetPattern (var thePattern: Pattern);	begin		GetIndPattern(thePattern, patListID, thePatterns^^[selection - 1]);	end;end.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          {****************************************************}{ 		CSelector.p}{}{		The Selector Class}{}{		Abstract class for a group of items from which a single selection can}{		be made, usually with the mouse.}{}{		SUPERCLASS = CPanorama}{}{		Copyright © 1989, Symantec Corporation.  All rights reserved.			}{}{****************************************************}UNIT CSelector;INTERFACEUSES	TCL, FW_Tearoffs;IMPLEMENTATION{****************************************************}{ ISelector}{}{		Initialize a Selector object}{}{****************************************************}PROCEDURE CSelector.ISelector (anEnclosure: CView;								aSupervisor: CBureaucrat;								aWidth, aHeight, aHEncl, aVEncl: integer;								aHSizing, aVSizing: SizingOption;								aNumItems, aSelection, aCommandBase: integer);	BEGIN		IPanorama(anEnclosure, aSupervisor, aWidth, aHeight, aHEncl, aVEncl, aHSizing, aVSizing);		wantsClicks := TRUE;		numItems := aNumItems;		selection := aSelection;		commandBase := aCommandBase;	END;{****************************************************}{ DoClick (OVERRIDE)}{}{		User clicked inside the selector. Turn of hiliting of the}{		newly selected item and unhilite the former selection. If}{		click is in the current selection, check for a double click.}{		Note that triple (and greater) clicks are ignored.}{}{****************************************************}PROCEDURE CSelector.DoClick (hitPt: Point;								modifierKeys: integer;								when: longint);	VAR		itemHit: integer;			{ Index no. of clicked item		}	BEGIN		itemHit := FindItem(hitPt);			{ Determine item clicked on		}		IF itemHit <> selection THEN			BEGIN								{ If this is a new selection ...	}				ChangeSelection(itemHit);		{   Change the current selection	}											{   Send command to supervisor	}				itsSupervisor.DoCommand(-(BSL(commandBase, 16) + itemHit));			END		ELSE IF gClicks = 2 THEN 			{ Item clicked is already the		}			DoDoubleClick;						{   current selection. See if it's	}											{   a double click.					}	END;{****************************************************}{ HitSamePart (OVERRIDE)}{}{		Check whether two points hit the same item in a Selector.}{		Points are in Window coordinates.}{}{****************************************************}FUNCTION CSelector.HitSamePart (pointA, pointB: Point): Boolean;	VAR		a, b: LongPt;	BEGIN		WindToFrame(pointA, a);				{ Convert points to Frame coords	}		WindToFrame(pointB, b);		HitSamePart := EqualLongPt(a, b);	END;{****************************************************}{ ChangeSelection}{}{		Select a new item by unhiliting the former selection and}{		hiliting the new item}{}{****************************************************}PROCEDURE CSelector.ChangeSelection (aSelection: integer);	BEGIN		IF aSelection <> selection THEN			BEGIN				IF visible THEN					BEGIN						HiliteItem(selection, hiliteOFF);						HiliteItem(aSelection, hiliteON);					END;				selection := aSelection;			END;	END;{****************************************************}{ GetSelection}{}{		Return the number of the currently selected item}{}{****************************************************}FUNCTION CSelector.GetSelection: integer;	BEGIN		GetSelection := selection;					{ Return instance variable			}	END;{****************************************************}{ SetCommandBase}{}{		Specify the value of the command base. When an item is chosen}{		the command number has the command base in the Hi word and the}{		item number in the Lo word.}{}{****************************************************}PROCEDURE CSelector.SetCommandBase (aCommandBase: integer);	BEGIN		commandBase := aCommandBase;	END;{****************************************************}{ GetCommandBase}{}{		Return the value of the command base. When an item is chosen}{		the command number has the command base in the Hi word and the}{		item number in the Lo word.}{}{****************************************************}FUNCTION CSelector.GetCommandBase: integer;	BEGIN		GetCommandBase := commandBase;		{ Return instance variable			}	END;{****************************************************}{ HiliteItem}{}{		Hilite an item in the specified way. Subclasses must override}{		this method.}{}{****************************************************}PROCEDURE CSelector.HiliteItem (theItem: integer;								state: HiliteState);	BEGIN	END;										{ Null Method						}{****************************************************}{ FindItem}{}{		Determine which item, if any, is selected by a click at the}{		specified hit point. Subclasses must override this method.}{}{****************************************************}FUNCTION CSelector.FindItem (hitPt: Point): integer;	BEGIN		FindItem := NOTHING;	END;{****************************************************}{ DoDoubleClick}{}{		Respond to a double-click on an item in a Selector. The first}{		click will have set the selection, so the item double-clicked}{		must be the current selection. Subclasses which support double}{		clicks must override this method.}{}{****************************************************}PROCEDURE CSelector.DoDoubleClick;	BEGIN	END;										{ Null Method						}END.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  (******************************************************************************}{ CSelectorMDEF.p}{}{							The SelectorMDEF Class}{		}{	Abstract class for a Menu Definition Procedure which uses a selector as}{	the basis for a menu. Most custom menus can be implemented by creating}{	a subclass of this class, since a Selector embodies all the characteristics}{	of a standard Mac menu: Display a group of choices and let the user}{	pick one, using appropriate highlighting as the mouse moves over an item.}{	}{	SUPERCLASS = CPaneMDEF}{	}{	Copyright © 1989 Symantec Corporation. All rights reserved.}{}{	Change History:}{		01/30/90	pb	Changed ChooseItem to use SetupQuickDraw and}{						RestoreQuickDraw.}{}{ ******************************************************************************)UNIT CSelectorMDEF;INTERFACEUSES	TCL, FW_Tearoffs;IMPLEMENTATION(******************************************************************************}{ ISelectorMDEF}{}{		Initialize a SelectorMDEF object}{ ******************************************************************************)PROCEDURE CSelectorMDEF.ISelectorMDEF (MDEFid: Integer;								aPane: CPane;								aTearOffMenu: CTearOffMenu);	BEGIN		INHERITED IPaneMDEF(MDEFid, aPane, aTearOffMenu);	END;(******************************************************************************}{ ChooseItem [OVERRIDE]}{}{		Determine which item in the menu is hit.}{ ******************************************************************************)PROCEDURE CSelectorMDEF.ChooseItem (macMenu: MenuHandle;								menuRect: Rect;								hitPt: Point;								VAR whichItem: Integer);	VAR		theItem: Integer;	BEGIN	(* hitPt is expressed in global coordinates, but we need it	*)	(* in pane coordinates. Take advantage of the fact that		*)	(* SetupQuickDraw sets up the grafport so the origin is the	*)	(* top left of the menu pane, and use the Toolbox's 		*)	(* GlobalToLocal to convert the hitPt to pane coordinates.	*)		IF (PtInRect(hitPt, menuRect)) THEN			BEGIN				SetupQuickDraw(menuRect);				GlobalToLocal(hitPt);				theItem := CSelector(itsPane).FindItem(hitPt);		(* Support the new MenuChoice feature described in IM V-240. *)		(* The low-memory global MenuDisable is updated to reflect   *)		(* the current menu and item ID, even if the mouse is over a *)		(* disabled item or menu. The HiWord of MenuDisable contains *)		(* the menu ID and the LoWord the menu item number.			 *)				MenuDisable^ := BOR(BSL(macMenu^^.menuID, 16), theItem);				IF (theItem <> NOTHING) & MenuEnabled(macMenu) THEN					BEGIN								(* Choosing item from enabled menu	*)								(* Provide visual feedback by		*)								(*   dynamically hiliting the item	*)						CSelector(itsPane).HiliteItem(theItem, hiliteDYNAMIC);						whichItem := theItem;					END				ELSE								(* No item is being chosen. Either	*)								(*   pointing at empty space or the	*)								(*   menu is disable.				*)					whichItem := NOTHING;				RestoreQuickDraw;			END		ELSE			BEGIN								(* Mouse is outside the menu		*)								(* Return item number of zero		*)				MenuDisable^ := BSL(Longint(macMenu^^.menuID), 16);				whichItem := NOTHING;								(* Tear off the menu if we have a	*)								(*   TearOffMenu object and the		*)								(*    menu is enabled (not dimmed)	*)				IF (itsTearOffMenu <> NIL) & MenuEnabled(macMenu) THEN					TearOffMenu(menuRect, hitPt);			END;	END;END.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    