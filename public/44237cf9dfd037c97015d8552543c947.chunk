ter, cmdAlignRight, cmdSingleSpace, cmd1HalfSpace, cmdDoubleSpace: 						doMakeStyleTask := TRUE;					OTHERWISE						INHERITED DoCommand(theCommand);				END;			END;		IF (doMakeStyleTask & stylable) THEN			BEGIN				itsTypingTask := NIL;				styleTask := MakeStyleTask(theCommand);				itsLastTask := styleTask;				itsSupervisor.Notify(styleTask);				styleTask.DoTask;			END;	END;FUNCTION FindItemCmd (menuID: Integer;								itemText: Str255): Longint;	VAR		itemNum: Integer;	BEGIN		itemNum := gBartender.FindItemText(menuID, itemText);		IF (itemNum > 0) THEN			FindItemCmd := gBartender.FindCmdNumber(menuID, itemNum)		ELSE			FindItemCmd := cmdNull;	END;(******************************************************************************}{ UpdateMenus [OVERRIDE]}{}{		Perform menu management tasks}{ ******************************************************************************)PROCEDURE CAbstractText.UpdateMenus;	VAR		macMenu: Ptr;		selStart: Longint;		selEnd: Longint;		cmdNum: Longint;		style: TextStyle;		styleFlags: Integer;		fontItem: Integer;		itemText: Str255;	BEGIN		INHERITED UpdateMenus;		IF wantsClicks THEN			gBartender.EnableCmd(cmdSelectAll);		GetSelection(selStart, selEnd);		IF (selStart <> selEnd) THEN			BEGIN				gBartender.EnableCmd(cmdCopy);				IF (editable) THEN					BEGIN						gBartender.EnableCmd(cmdCut);						gBartender.EnableCmd(cmdClear);					END;			END;		IF editable & (gClipboard.DataSize('TEXT') > 0) THEN			BEGIN				gBartender.EnableCmd(cmdPaste);			END;		(* The remaining menu updating involves style and formatting*)		(* commands. Don't do it if the text is not stylable.*)		IF (NOT stylable) THEN			EXIT(UpdateMenus);		(* Get selection returns the "current" text attributes. For 	*)		(* single-style text these are the global attributes and are	*)		(* by definition always continous. For multi-style text, it		*)		(* returns the attributes of the selections, and the returned	*)		(* flags indicate which are continuous							*)		styleFlags := doFont + doFace + doSize;		GetTextStyle(styleFlags, style);		IF BAND(styleFlags, doFont) <> 0 THEN			BEGIN		(* lastFontNum is the last font number seen from UpdateMenus *)		(* lastFontCmd is the cmd # corresponding to lastFontNum	 *)		(* if lastFontNum == style.tsFont, then we don't need to	 *)		(* lookup the font name in the menu again					 *)				IF (lastFontNum <> style.tsFont) THEN					BEGIN						lastFontNum := style.tsFont;						GetFontName(style.tsFont, itemText);						lastFontCmd := FindItemCmd(MENUfont, itemText);					END;				IF (lastFontCmd <> cmdNull) THEN					gBartender.CheckMarkCmd(lastFontCmd, TRUE);			END;		IF (BAND(styleFlags, doSize) <> 0) THEN			BEGIN			(* Font size of zero means the system default size,*)			(* but we need a real number for the size menu.*)				IF (style.tsSize = 0) THEN					style.tsSize := GetDefFontSize;			(* lastTextSize is the last text size seen from UpdateMenus	*)			(* lastSizeCmd is the cmd # corresponding to lastFontNum	*)			(* if lastTextSize == style.tsSize, then we don't need to	*)			(* lookup the size in the menu again						*)				IF (lastTextSize <> style.tsSize) THEN					BEGIN						lastTextSize := style.tsSize;						NumToString(style.tsSize, itemText);						lastSizeCmd := FindItemCmd(MENUsize, itemText);					END;				IF (lastSizeCmd <> cmdNull) THEN					gBartender.CheckMarkCmd(lastSizeCmd, TRUE);			END;		IF (BAND(styleFlags, doFace) <> 0) THEN			BEGIN				IF (style.tsFace = []) THEN					BEGIN						gBartender.CheckMarkCmd(cmdPlain, TRUE);					END				ELSE					BEGIN						IF bold IN style.tsFace THEN							BEGIN								gBartender.CheckMarkCmd(cmdBold, TRUE);							END;						IF italic IN style.tsFace THEN							BEGIN								gBartender.CheckMarkCmd(cmdItalic, TRUE);							END;						IF underline IN style.tsFace THEN							BEGIN								gBartender.CheckMarkCmd(cmdUnderline, TRUE);							END;						IF outline IN style.tsFace THEN							BEGIN								gBartender.CheckMarkCmd(cmdOutline, TRUE);							END;						IF shadow IN style.tsFace THEN							BEGIN								gBartender.CheckMarkCmd(cmdShadow, TRUE);							END;						IF condense IN style.tsFace THEN							BEGIN								gBartender.CheckMarkCmd(cmdCondense, TRUE);							END;						IF extend IN style.tsFace THEN							BEGIN								gBartender.CheckMarkCmd(cmdExtend, TRUE);							END;					END;			END;		cmdNum := GetAlignCmd;		IF (cmdNum <> cmdNull) THEN			gBartender.CheckMarkCmd(cmdNum, TRUE);		cmdNum := GetSpacingCmd;		IF (cmdNum <> cmdNull) THEN			gBartender.CheckMarkCmd(cmdNum, TRUE);	END;(******************************************************************************}{ DoKeyDown [OVERRIDE]}{}{	Handles keystrokes as follows:}{}{		1. The Home, Page up, Page down, and all command keys are passed}{		   to the superclass, where they can travel up the command chain.}{		2. The End key handling is overriden to scroll to the bottom left}{		   of the text.}{		3. Cursor keys are passed to the superclass, and the current typing}{		   task, if any, is notified of the change in selection.}{		4. All other keystrokes are handled by the current typing task.}{ ******************************************************************************)PROCEDURE CAbstractText.DoKeyDown (theChar: Char;								keyCode: Byte;								macEvent: EventRecord);	VAR		thePosition: LongPt;		theHExtent: Longint;		theVExtent: Longint;		typingTask: CTextEditTask;	BEGIN		IF (BAND(macEvent.modifiers, cmdKey) <> 0) THEN			BEGIN			(* Don't try to insert any command keys into the text,	*)			(* pass them along the command chain					*)				INHERITED DoKeyDown(theChar, keyCode, macEvent);				EXIT(DoKeyDown);			END;		CASE keyCode OF			KeyHome, KeyPageUp, KeyPageDown: 				INHERITED DoKeyDown(theChar, keyCode, macEvent);			KeyEnd: 				IF (itsScrollPane <> NIL) THEN					BEGIN						GetExtent(theHExtent, theVExtent);						thePosition.h := 0;						thePosition.v := Max(0, theVExtent - itsScrollPane.vSpan);						ScrollTo(thePosition, TRUE);						itsScrollPane.Calibrate;					END;			KeyLeftCursor, KeyRightCursor, KeyUpCursor, KeyDownCursor: 				IF editable THEN	{ TCL 1.1.1 DLP 9/27/91 }					BEGIN						TypeChar(theChar, macEvent.modifiers);						SelectionChanged;					END;			OTHERWISE				IF editable THEN	{ TCL 1.1.1 DLP 9/27/91 }					BEGIN						IF (itsTypingTask <> NIL) & (NOT itsTypingTask.CanStillType) THEN							BEGIN								itsSupervisor.Notify(NIL);								itsTypingTask := NIL;							END;						IF (itsTypingTask = NIL) THEN							BEGIN								typingTask := MakeEditTask(cmdNull);								itsLastTask := typingTask;								itsSupervisor.Notify(typingTask);								itsTypingTask := typingTask;							END;						itsTypingTask.DoTyping(theChar, keyCode, macEvent);					END;		END;	END;(******************************************************************************}{ DoAutoKey [OVERRIDE]}{}{		Handle a key being held down. Treat this the same as a normal}{		keystroke.}{ ******************************************************************************)PROCEDURE CAbstractText.DoAutoKey (theChar: Char;								keyCode: Byte;								macEvent: EventRecord);	BEGIN		IF (BAND(macEvent.modifiers, cmdKey) = 0) THEN			DoKeyDown(theChar, keyCode, macEvent);	END;(******************************************************************************}{ TypeChar}{}{	Process a single keystroke. All undo setup has already been performed,}{	and the keystroke should be handled directly.}{ ******************************************************************************)PROCEDURE CAbstractText.TypeChar (theChar: Char;								theModifiers: Integer);	BEGIN		SubclassResponsibility;	END;(******************************************************************************}{ BecomeGopher [OVERRIDE]}{ }{ 	If fBecoming is TRUE the pane is becoming the gopher, otherwise}{ 	it is about to stop being the gopher.}{******************************************************************************)FUNCTION CAbstractText.BecomeGopher (fBecoming: Boolean): Boolean;	BEGIN		IF (NOT INHERITED BecomeGopher(fBecoming)) THEN			BEGIN				BecomeGopher := FALSE;				EXIT(BecomeGopher);			END;		IF (fBecoming) THEN			BEGIN				Activate;				IF (stylable) THEN					BEGIN						gBartender.EnableMenu(MENUfont);						gBartender.EnableMenu(MENUsize);						gBartender.EnableMenu(MENUstyle);					END;			END		ELSE			BEGIN				Deactivate;				IF (stylable) THEN					BEGIN						gBartender.DisableMenu(MENUfont);						gBartender.DisableMenu(MENUsize);						gBartender.DisableMenu(MENUstyle);					END;			END;		BecomeGopher := TRUE;	END;(******************************************************************************}{ SetSelection}{}{ 	Sets the selected text to the range corresponding to character positions}{ 	selStart through selEnd.}{******************************************************************************)PROCEDURE CAbstractText.SetSelection (selStart: Longint;								selEnd: Longint;								fRedraw: Boolean);	BEGIN		SubclassResponsibility;	END;(******************************************************************************}{ SelectAll}{}{ 	Selects all the text}{******************************************************************************)PROCEDURE CAbstractText.SelectAll (fRedraw: Boolean);	BEGIN		SetSelection(0, GetLength, fRedraw);	END;(******************************************************************************}{ AdjustCursor [OVERRIDE]}{}{		Mouse is inside an AbstractText Pane. Use the standard IBeam cursor.}{ ******************************************************************************)PROCEDURE CAbstractText.AdjustCursor (where: Point;	(* Mouse location in Window coords	*)								mouseRgn: RgnHandle);	BEGIN		SetCursor(gIBeamCursor^^);	END;(******************************************************************************}{ GetSpacingCmd}{}{	Return line spacing.}{ ******************************************************************************)FUNCTION CAbstractText.GetSpacingCmd: Longint;	BEGIN		SubclassResponsibility;	END;(******************************************************************************}{ GetSelection}{}{	Return the start and end of the selection.}{ ******************************************************************************)PROCEDURE CAbstractText.GetSelection (VAR selStart, selEnd: Longint);	BEGIN		SubclassResponsibility;	END;(******************************************************************************}{ GetNumLines}{}{	Return the number of lines of text.}{ ******************************************************************************)FUNCTION CAbstractText.GetNumLines: Longint;	BEGIN		SubclassResponsibility;	END;(******************************************************************************}{ Specify}{}{	Specify whether the text is selectable and or editable. Note that}{	the text cannot be editable or stylable without also being selectable.}{}{ ******************************************************************************)PROCEDURE CAbstractText.Specify (fEditable, fSelectable, fStylable: Boolean);	BEGIN		IF (NOT fSelectable) THEN			BEGIN				fEditable := FALSE;				fStylable := FALSE;			END;		editable := fEditable;		SetWantsClicks(fSelectable);		stylable := fStylable;		(* if the text is selectable, then it can be the gopher *)		SetCanBeGopher(fSelectable);	{ TCL 1.1.1 DLP 9/27/91 }	END;(******************************************************************************}{ GetSpecification}{}{	Return characteristics of the text pane.}{		}{ ******************************************************************************)PROCEDURE CAbstractText.GetSpecification (VAR fEditable, fSelectable, fStylable: Boolean);	BEGIN		fEditable := editable;		fSelectable := wantsClicks;		fStylable := stylable;	END;(******************************************************************************}{ CopyTextRange}{}{	Return a copy of the currently selected text.}{ ******************************************************************************)FUNCTION CAbstractText.CopyTextRange (startPos, endPos: Longint): Handle;	BEGIN		SubclassResponsibility;	END;(******************************************************************************}{ PerformEditCommand}{}{	Perform the standard cut, copy, paste, and clear commands on the}{	text.}{ ******************************************************************************)PROCEDURE CAbstractText.PerformEditCommand (theCommand: Longint);	BEGIN		SubclassResponsibility;	END;(******************************************************************************}{ InsertTextPtr}{}{	Insert a copy of the given text at the start of the selection.}{ ******************************************************************************)PROCEDURE CAbstractText.InsertTextPtr (text: Ptr;								length: Longint;								fRedraw: Boolean);	BEGIN		SubclassResponsibility;	END;(******************************************************************************}{ InsertTextHandle}{}{	Insert a copy of the given text at the start of the selection.}{ ******************************************************************************)PROCEDURE CAbstractText.InsertTextHandle (text: Handle;								fRedraw: Boolean);	VAR		state: SignedByte;	BEGIN		state := HGetState(text);		MoveHHi(text);		HLock(text);		InsertTextPtr(text^, GetHandleSize(text), fRedraw);		HSetState(text, state);	END;(******************************************************************************}{ SelectionChanged}{}{	Called after the selection may have changed to notify dependants.}{ ******************************************************************************)PROCEDURE CAbstractText.SelectionChanged;	BEGIN		BroadcastChange(textSelectionChanged, NIL);		IF (itsTypingTask <> NIL) THEN			itsTypingTask.SelectionChanged;	END;(******************************************************************************}{ MakeEditTask}{}{	Create a task to carry out typing, cut, copy, paste, and clear commands.}{	Must be a subclass of CTextEditTask.}{ ******************************************************************************)FUNCTION CAbstractText.MakeEditTask (editCmd: Longint): CTextEditTask;	VAR		newTask: CTextEditTask;		fi: FailInfo;	PROCEDURE HandleFailure (error: Integer;									message: Longint);		BEGIN			ForgetObject(newTask);		END;	BEGIN		newTask := NIL;		CatchFailures(fi, HandleFailure);		NEW(newTask);		newTask.ITextEditTask(SELF, editCmd, cFirstTaskIndex);		Success;		MakeEditTask := newTask;	END;(******************************************************************************}{ MakeStyleTask}{}{	Create a task to carry out font, style, size, alignment, and spacing}{	commands. Must be a subclass of CTextStyleTask.}{ ******************************************************************************)FUNCTION CAbstractText.MakeStyleTask (styleCmd: Longint): CTextStyleTask;	VAR		newTask: CTextStyleTask;		taskIndex: Integer;		fi: FailInfo;	PROCEDURE HandleFailure (error: Integer;									message: Longint);		BEGIN			ForgetObject(newTask);		END;	BEGIN		newTask := NIL;		CatchFailures(fi, HandleFailure);		IF (cFirstTaskIndex > 0) THEN			taskIndex := cFirstTaskIndex + undoFormatting		ELSE			taskIndex := 0;		NEW(newTask);		newTask.ITextStyleTask(SELF, styleCmd, taskIndex);		Success;		MakeStyleTask := newTask;	END;(******************************************************************************}{ GetCharBefore}{}{	Return the character before aPosition. The character and its size}{	are returned in charBuf, and aPosition is updated with the starting}{	position of the character. If there is no preceding character, then}{	Length(charBuf) is 0, and aPosition is not updated.}{}{ ******************************************************************************)PROCEDURE CAbstractText.GetCharBefore (VAR aPosition: Longint;								VAR charBuf: tCharBuf);	VAR		h: Handle;		text: CharsPtr;		charSize: Integer;		i: Integer;		charPos: Longint;	BEGIN				(* nothing in this method moves memory	*)		h := GetTextHandle;		text := CharsPtr(h^);		IF ((aPosition > 0) & (GetHandleSize(h) > 0)) THEN			BEGIN				charPos := aPosition - 1;				IF (gSystem.scriptsInstalled > 1) THEN					BEGIN					(* must use CharByte to get character.			*)					(* CharByte does not move memory				*)						WHILE CharByte(Ptr(text), charPos) > 0 DO							charPos := charPos - 1;						charSize := aPosition - charPos;						aPosition := charPos;{$PUSH}{$R-}						charBuf[0] := char(charSize);{$POP}						FOR i := 1 TO charSize DO							BEGIN								charBuf[i] := text^[charPos];								charPos := charPos + 1;							END;					END				ELSE					BEGIN						aPosition := charPos;						charBuf := text^[charPos];					END;			END		ELSE			charBuf := '';	END;(******************************************************************************}{ GetCharAfter}{}{	Return the character after aPosition. The character and its size}{	are returned in charBuf, and aPosition is updated with the starting}{	position of the character. If there is no following character, then}{	Length(charBuf) is 0, and aPosition is not updated.}{}{ ******************************************************************************)PROCEDURE CAbstractText.GetCharAfter (VAR aPosition: Longint;								VAR charBuf: tCharBuf);	VAR		h: Handle;		text: CharsPtr;		charPos: Longint;		textLen: Longint;	BEGIN					(* nothing in this method moves memory	*)		h := GetTextHandle;		textLen := GetLength;		text := CharsPtr(h^);		IF ((textLen > 0) & (aPosition < textLen)) THEN			BEGIN				charPos := aPosition;				IF (gSystem.scriptsInstalled > 1) THEN					BEGIN				(* must use CharByte to get character.			*)				(* CharByte does not move memory				*)						charBuf := '';						WHILE (charPos <= textLen) & (CharByte(Ptr(text), charPos) > 0) DO							BEGIN				{$PUSH}				{$R-}								charBuf[0] := char(ord(charBuf[0]) + 1);								charBuf[ord(charBuf[0])] := text^[charPos];								charPos := charPos + 1;				{$POP}							END;						aPosition := charPos;					END				ELSE					BEGIN						aPosition := charPos;						charBuf := text^[charPos];					END;			END		ELSE			charBuf := '';	END;(******************************************************************************}{ Paginate}{******************************************************************************)PROCEDURE CAbstractText.Paginate (aPrinter: CPrinter;								pageWidth: Integer;								pageHeight: Integer);	VAR		linesPerPage: Integer;		lineHeight: Integer;		stripNum: Integer;		currLine: Longint;		numLines: Longint;		nextPageBreak: Longint;		totalPix: Longint;	BEGIN		IF (fixedLineHeights) THEN			BEGIN			(* force pageHeight to include only full lines	*)							(* use height of line 1 as height of all lines *)				lineHeight := Get1Height(1);				linesPerPage := pageHeight DIV lineHeight;				pageHeight := lineHeight * linesPerPage;				(* CPanorama will paginate into equal sized strips given	*)				(* the new page height										*)				INHERITED Paginate(aPrinter, pageWidth, pageHeight);			END		ELSE			BEGIN				aPrinter.ResetPagination;				numLines := GetNumLines;				nextPageBreak := pageHeight;				stripNum := 0;				totalPix := 0;				aPrinter.SetHorizPageBreak(1, pageWidth);				FOR currLine := 1 TO numLines DO					BEGIN						lineHeight := Get1Height(currLine);						totalPix := totalPix + lineHeight;						IF (totalPix > nextPageBreak) THEN							BEGIN								stripNum := stripNum + 1;								aPrinter.SetVertPageBreak(stripNum, totalPix - lineHeight);								totalPix := nextPageBreak + lineHeight;								nextPageBreak := nextPageBreak + pageHeight;							END;					END;				IF (totalPix > nextPageBreak - pageHeight) THEN					BEGIN						stripNum := stripNum + 1;						aPrinter.SetVertPageBreak(stripNum, nextPageBreak);					END;			END;	END;END.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                2                                CAbstractText.p   TEXTPJMM@     TEXTPJMM@                       ¤X “      L     Ã                           Ä                                                                   Å                               €   1.1.2	TCL 1.1.2           2 i’œü    2  vers   
 ÿÿ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            (******************************************************************************}{ CAppleEvent.p}{}{	A class that encapsulates an incoming AppleEvent and its default reply.}{	AppleEvents are received by the application's switchboard and packaged}{	into a CAppleEvent object by the application. The CAppleEvent object}{	is then passed down the chain of command, just like menu commands and}{	keystrokes. CApplication handles the four required AppleEvents. To handle}{	other AppleEvents, override the DoAppleEvent method in your pane, director,}{	document, or application subclass.}{}{		Copyright © 1991 Symantec Corporation. All rights reserved.}{}{ ******************************************************************************)UNIT CAppleEvent;INTERFACEUSES	TCL, CSwitchboard;IMPLEMENTATION(******************************************************************************}{ IAppleEvent}{}{ 	Initialize a CAppleEvent object. theEvent is the AppleEvent as received by }{ 	CSwitchboard. theReply is the default reply the AppleEvent manager generates}{ 	when an AppleEvent is sent. theRefCon is the reference value associated}{ 	with the particular event class and ID. Normally in the TCL it is zero.}{ 	eventClass and eventID are simply the event class and ID which were extracted}{ 	from theEvent.}{}{******************************************************************************)PROCEDURE CAppleEvent.IAppleEvent (aeEvent: AppleEvent;								aeReply: AppleEvent;								aeRefCon: Longint;								aeEventClass, aeEventID: DescType);	BEGIN		SELF.theEvent := aeEvent;		SELF.theReply := aeReply;		SELF.theRefCon := aeRefCon;		SELF.eventClass := aeEventClass;		SELF.eventID := aeEventID;		notificationRec := NIL;		idleProc := NIL;	(* canInteract indicates whether user interaction has been*)	(* requested and approved.*)		canInteract := FALSE;	(* errCode is used to store the error code ultimately*)	(* returned back to the AppleEvent mgr, which in turn will*)	(* pass it to the sender. It is initialized to errAEEventNotHandled*)	(* to indicate that the event has not yet been handled. If no object in*)	(* the chain of command handles an event, then errCode will*)	(* not be changed, and the sender will be informed that the*)	(* event wasn't handled.*)		errCode := errAEEventNotHandled;	END;(******************************************************************************}{ GetAEEvent}{}{ 	Return the AppleEvent}{******************************************************************************)FUNCTION CAppleEvent.GetAEEvent: AppleEvent;	BEGIN		GetAEEvent := theEvent;	END;(******************************************************************************}{ GetAEReply}{}{ 	Return the AppleEvent reply}{******************************************************************************)FUNCTION CAppleEvent.GetAEReply: AppleEvent;	BEGIN		GetAEReply := theReply;	END;(******************************************************************************}{ GetAERefCon}{}{ 	Return the AppleEvent reference value, which is associated with a given}{ 	event class and ID when AEInstallEventHandler is called. The TCL always}{ 	initializes this to zero, but other values could be used if your}{ 	application calls AEInstallHandler itself.}{}{******************************************************************************)FUNCTION CAppleEvent.GetAERefCon: Longint;	BEGIN		GetAERefCon := theRefCon;	END;(******************************************************************************}{ GetEventClass}{}{ 	Return the event class, e.g. 'aevt'. The event class and ID together}{ 	uniquely determine a particular AppleEvent.}{******************************************************************************)FUNCTION CAppleEvent.GetEventClass: DescType;	BEGIN		GetEventClass := eventClass;	END;(******************************************************************************}{ GetEventID}{}{ 	Return the event ID, e.g. 'oapp'.}{******************************************************************************)FUNCTION CAppleEvent.GetEventID: DescType;	BEGIN		GetEventID := eventID;	END;(******************************************************************************}{ GetDescList}{}{ 	Return the AEDescList associated with the keyword whichParam.}{******************************************************************************)PROCEDURE CAppleEvent.GetDescList (whichParam: AEKeyword;								VAR descList: AEDescList);	VAR		theList: AEDescList;		event: AppleEvent;	BEGIN		event := SELF.theEvent;		FailOSErr(AEGetParamDesc(event, whichParam, typeAEList, theList));		descList := theList;	END;(******************************************************************************}{ ExtractFromDescList}{}{ 	Gets the descriptor list associated with the parameter whichParam,}{ 	and extracts all the items in the list into a CArray. This is a}{ 	useful utility if all the items in the list are the same size}{ 	and the data in the list is not keyword separated - the keywords}{ 	are not used here.}{******************************************************************************)FUNCTION CAppleEvent.ExtractFromDescList (whichParam: AEKeyword;								itemType: DescType;								itemSize: Size): CArray;	VAR		descList: AEDescList;		theArray: CArray;		itemCount: Longint;		i: Longint;		keyword: AEKeyword;		actualType: DescType;		actualSize: Longint;		bufH: Handle;		itemBuffer: Ptr;		fi: FailInfo;		err: OSErr;	PROCEDURE HandleFailure (error: Integer;									message: Longint);		BEGIN			ForgetHandle(bufH);			ForgetObject(theArray);			err := AEDisposeDesc(descList);		END;	BEGIN		bufH := NIL;		theArray := NIL;		descList.dataHandle := NIL;		CatchFailures(fi, HandleFailure);		GetDescList(whichParam, descList);		NEW(theArray);		theArray.IArray(itemSize);		bufH := NewHandleCanFail(itemSize);		FailNIL(bufH);		MoveHHi(bufH);		HLock(bufH);		itemBuffer := bufH^;		FailOSErr(AECountItems(descList, itemCount));		FOR i := 1 TO itemCount DO			BEGIN				FailOSErr(AEGetNthPtr(descList, i, itemType, keyword, actualType, itemBuffer, itemSize, actualSize));				theArray.InsertAtIndex(itemBuffer, i); { TCL 1.1.1 DLP 10/1/91 }			END;		Success;		ForgetHandle(bufH);		FailOSErr(AEDisposeDesc(descList));		ExtractFromDescList := theArray;	END;(******************************************************************************}{ GetErrorResult}{}{ 	Return the error code for this event. It will be noErr if the}{ 	event was handled successfully, errAEEventNotHandled if the event}{ 	was not handled, or some other result code if someone attempted to handle }{    it, failed, and stored a result code. Note that CSwitchboard uses a special}{    exception handler to trap exceptions raised during the handling of an}{    AppleEvent, and will return the exception error instead.}{}{******************************************************************************)FUNCTION CAppleEvent.GetErrorResult: Integer;	BEGIN		GetErrorResult := errCode;	END;(******************************************************************************}{ SetErrorResult}{}{ 	Set the result code for this event}{******************************************************************************)PROCEDURE CAppleEvent.SetErrorResult (anErrorCode: Integer);	BEGIN		errCode := anErrorCode;	END;(******************************************************************************}{ GotRequiredParams}{}{ 	Does the recommended check to determine if all the required parameters}{ 	of an AppleEvent have already been extracted. You should call this}{ 	method after you extract all the parameters you know about, and before}{ 	you actually handle the event.}{}{******************************************************************************)FUNCTION CAppleEvent.GotRequiredParams: Boolean;	VAR		returnedType: DescType;		actualSize: Longint;		err: Integer;	BEGIN		err := AEGetAttributePtr(theEvent, keyMissedKeywordAttr, typeWildCard, returnedType, NIL, 0, actualSize);		GotRequiredParams := err = errAEDescNotFound;	END;(******************************************************************************}{ RequestInteraction}{}{ 	Indicates to the OS that you need to interact with the user (e.g. put}{ 	up a dialog) in order to handle the event. If interaction is allowed,}{ 	and if the application is brought forward before the timeout period}{ 	has elapsed, then noErr is returned and you can proceed with the interaction.}{ 	If any other value is returned, then interaction is not allowed or your}{ 	timeout period elapsed (check the result code).}{}{ 	CSwitchboard provides a default AppleEvent idle proc that can be used}{ 	with AEInteractWithUser or AESend. To provide a custom one, put a pointer}{ 	to it in the idleproc instance variable. The AppleEvent mgr provides}{ 	a default, notification mgr record if NIL is passed to AEInteractWithUser.}{ 	The TCL uses the default, but you can provide a custom one by providing a}{ 	pointer to it in the notificationRec instance variable.}{}{******************************************************************************)FUNCTION CAppleEvent.RequestInteraction (timeOutTicks: Longint): Integer;	VAR		err: Integer;		proc: Ptr;	BEGIN	(* Don't call AEInteractWithUser again if it has already been*)	(* requested and approved.*)		IF (NOT canInteract) THEN			BEGIN				IF (SELF.idleProc <> NIL) THEN					proc := SELF.idleProc				ELSE					proc := @AppleEventIdleProc;				err := AEInteractWithUser(timeOutTicks, notificationRec, proc);				IF (err = noErr) THEN					canInteract := TRUE;			END		ELSE			err := noErr;		RequestInteraction := err;	END;END.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     2  ª   ê   ì  «  ¯   ø      ±CAppleEvent.p   TEXTPJMM@       TEXTPJMM@                       ¤Uü;      LÆ          U          X  È  Î          Ï  Z  [  Ñ  Ù      Û  ^  _  `  a  Ü  ß  b      å  è  ë      À     @   €   1.1.2	TCL 1.1.2           2 i’œü    2  vers   
 ÿÿ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            (******************************************************************************}{ CApplication.p}{}{							The Application Class}{		}{	Abstract class for a Mac application. Programmers must create a subclass}{	of CApplication for their own programs. The application is at the top of}{	the chain of command and defines the behavior of the program and its}{	interaction with the Mac OS.}{	}{	SUPERCLASS = CDirectorOwner}{	}{	Copyright © 1989 Symantec Corporation. All rights reserved.}{	}{		written by: Gregory H. Dow (version 1.1 by Dan Podwall)}{		}{	TCL 1.1 CHANGES}{	[}{		- IApplication now initializes the gApplication global, so the}{	      main() function does not need to (but still can if it wants to).}{	    - implemented GetPhase, DoAppleEvents methods.}{	    - modified Notify to dispose of tasks that aren't caught by}{	      any document}{	]}{}{ ******************************************************************************)UNIT CApplication;INTERFACEUSES	TCL;IMPLEMENTATIONUSES	SysEqu, MethTableUtils, Script;VAR	origETS: Longint;{$PUSH}{$Z+}	(* make this visible to TCL.lib *)	origLoadSeg: Longint;{$POP}PROCEDURE JmpToProc (proc: ProcPtr);INLINE	$205F, $4ED0;PROCEDURE LoadSeg_Patch;EXTERNAL;(**** I N I T I A L I Z A T I O N    M E T H O D S ****)(******************************************************************************}{ IApplication}{ }{		Initialize an Application.}{ ******************************************************************************)PROCEDURE CApplication.IApplication (extraMasters: Integer;	(* Number of additional master		*)														(*   blocks to allocate			*)								aRainyDayFund: Longint;(* Bytes of memory to reserve for	*)														(*   a rainy day					*)								aCriticalBalance: Longint;(* Bytes to save for critical 		*)														(* operations					*)								aToolboxBalance: Longint); (* Bytes to savefor the toolbox *)	VAR		list: CList;		cluster: CCluster;	BEGIN		gApplication := SELF;	(* initialize the global pointer *)		MenuDisable := LongPtr($B54);				{ Low-memory global	}		nullStr := '';		(* indicate initialization phase *)		phase := appInitializing;		(* Initialize Toolbox Managers		*)		InitToolbox;		(* Fine tune the Memory Manager		*)		InitMemory(extraMasters, aRainyDayFund, aCriticalBalance, aToolboxBalance);		IDirectorOwner(NIL);		InspectSystem;		InstallPatches;		MakeSwitchboard;		NEW(list);		itsIdleChores := list;		itsIdleChores.IList;		NEW(cluster);		itsUrgentChores := cluster;		itsUrgentChores.ICluster;		urgentsToDo := FALSE;		running := TRUE;		unhandledTask := NIL;		gSignature := '????';		(* We want an early first Idle		*)		gSleepTime := 0;		(* Initialize cMaxSleepTime to 10 seconds. This is an arbitrary*)		(* value which gives screen savers, clocks, etc. some time,*)		(* without stealing too much time from other processes.*)		(* Applications can override it by simply assigning a new value to it.*)		cMaxSleepTime := 600;		MakeError;				(* Cursors							*)		gIBeamCursor := GetCursor(iBeamCursor);		HNoPurge(Handle(gIBeamCursor));		gWatchCursor := GetCursor(watchCursor);		HNoPurge(Handle(gWatchCursor));		gUtilRgn := NewRgn;		MakeDesktop;		MakeClipboard;		MakeDecorator;		SetUpFileParameters;		SetUpMenus;		gGopher := SELF;		gLastViewHit := NIL;		gLastMouseUp.when := 0;		gClicks := 0;		InitMethTableUtils;		ForceClassReferences;	{ TCL 1.1.1 DLP 9/27/91 }	END;(******************************************************************************}{ InitToolbox}{}{		Initialize the Macintosh Toolbox}{ ******************************************************************************)PROCEDURE CApplication.InitToolbox;	BEGIN	(* Standard initialization calls	*)		InitGraf(@thePort);		InitFonts;		InitWindows;		InitMenus;		TEInit;		InitDialogs(NIL);		InitCursor;	END;(******************************************************************************}{ InitMemory}{ }{		Initialize the Heap and create extra master pointer blocks}{ ******************************************************************************)PROCEDURE CApplication.InitMemory (extraMasters: Integer; (* Number of additional master		*)													(*   blocks to allocate				*)								aRainyDayFund: Longint;(* Bytes of memory to reserve for	*)													    (*   a rainy day					*)								aCriticalBalance: Longint;(* Bytes to reserve for critical	*)														(* operations						*)								aToolboxBalance: Longint);	(* Bytes to reserve for those toolbox *)															(* routines that don't fail gracefully *)	BEGIN		ASSERT(aRainyDayFund >= aCriticalBalance);		ASSERT(aCriticalBalance >= aToolboxBalance);					(* Grow heap to maximum size to		*)		MaxApplZone;	(*   help prevent fragmentation		*)		(* Call MoreMasters to allocate extra master pointers.  *)		(* Experiment to determine how many master pointers the *)		(* application uses under session of heavy use.			*)		WHILE extraMasters > 0 DO			BEGIN				extraMasters := extraMasters - 1;				MoreMasters;			END;		SetGrowZone(@GrowZoneFunc); (* Traps out of memory conditions	*)		rainyDay := NIL;								(* Set instance variables			*)		rainyDayFund := aRainyDayFund;		criticalBalance := aCriticalBalance;		toolboxBalance := aToolboxBalance;		rainyDayUsed := FALSE;		memWarningIssued := FALSE;		canFail := FALSE;		inCriticalOperation := FALSE;		tempAllocation := 0;		rainyDay := NewHandleCanFail(rainyDayFund); (* Reserve a block of memory *)		FailNIL(rainyDay);	END;(******************************************************************************}{ InstallPatches}{ }{		Install the TCL trap patches. Patches LoadSeg and ExitToShell}{ ******************************************************************************){$PUSH}{$D-}PROCEDURE ETS_Patch;	VAR		oldA5, realETS: Longint;	BEGIN		oldA5 := SetCurrentA5;		IF (gApplication <> NIL) THEN			gApplication.RemovePatches;		realETS := origETS;		oldA5 := SetA5(oldA5);		JmpToProc(ProcPtr(realETS));	END;{$D+}PROCEDURE CApplication.InstallPatches;	VAR		trap: Integer;	BEGIN		trap := BAND($A9F4, $3FF);		origETS := NGetTrapAddress(trap, ToolTrap);		NSetTrapAddress(Longint(@ETS_Patch), trap, ToolTrap);		trap := BAND($A9F0, $3FF);		origLoadSeg := NGetTrapAddress(trap, ToolTrap);		NSetTrapAddress(Longint(@LoadSeg_Patch), trap, ToolTrap);	END;(******************************************************************************}{ RemovePatches}{ }{		Remove the TCL trap patches}{ ******************************************************************************)PROCEDURE CApplication.RemovePatches;	VAR		trap: Integer;	BEGIN		IF (origETS <> 0) THEN			BEGIN				trap := BAND($A9F4, $3FF);				NSetTrapAddress(origETS, trap, ToolTrap);				trap := BAND($A9F0, $3FF);				NSetTrapAddress(origLoadSeg, trap, ToolTrap);			END;	END;(******************************************************************************}{ ForceClassReferences}{ }{	If there are classes in your program that are only created via new by}{	name and never referenced directly, you must add a dummy reference to}{	prevent smart-linking from stripping the classes from your built application.}{	Override ForceClassReferences in your application subclasses and reference}{	the classes as shown below. CApplication automatically calls }{	ForceClassReferences for you.}{	}{ ******************************************************************************)PROCEDURE CApplication.ForceClassReferences;	BEGIN{$IFC FALSE}		VAR		(* example of referencing classes used only with NewByName *)			alwaysFalse, ignore: Boolean;			dummy: CObject;			alwaysFalse := FALSE;			IF alwaysFalse THEN				BEGIN					ignore := member(dummy, CCheckbox);					ignore := member(dummy, CRadioControl);					ignore := member(dummy, CRadioGroupPane);		(* etc... *)				END;{$ENDC}	END;(******************************************************************************}{ InspectSystem}{ }{	Gather information about the current OS}{ ******************************************************************************)PROCEDURE CApplication.InspectSystem;	VAR		err: Integer;		environs: SysEnvRec;		response: Longint;	BEGIN		gSystem.hasGestalt := TrapAvailable(_GestaltDispatch);		gSystem.hasWNE := WNEIsImplemented;		gSystem.hasScriptMgr := TrapAvailable(_ScriptUtil);		gSystem.scriptsInstalled := 1; (* assume only Roman script	*)		err := SysEnvirons(1, environs);		IF (err = noErr) THEN			BEGIN				gSystem.hasColorQD := environs.hasColorQD;				gSystem.hasFPU := environs.hasFPU;				gSystem.systemVersion := environs.systemVersion;			END		ELSE			BEGIN				gSystem.hasColorQD := FALSE;				gSystem.hasFPU := FALSE;				gSystem.systemVersion := 0;			END;		IF (gSystem.hasGestalt) THEN			BEGIN				gSystem.hasAppleEvents := Gestalt(gestaltAppleEventsAttr, response) = noErr;				gSystem.hasAliasMgr := Gestalt(gestaltAliasMgrAttr, response) = noErr;				gSystem.hasEditionMgr := Gestalt(gestaltEditionMgrAttr, response) = noErr;				gSystem.hasHelpMgr := Gestalt(gestaltHelpMgrAttr, response) = noErr;				IF (gSystem.hasScriptMgr) THEN					BEGIN						err := Gestalt(gestaltScriptCount, response);						IF (err = noErr) THEN							gSystem.scriptsInstalled := Integer(response);					END;			END		ELSE	(* If we don't have Gestalt, then we can't have any System 7 features	*)			BEGIN				gSystem.hasAppleEvents := FALSE;				gSystem.hasAliasMgr := FALSE;				gSystem.hasEditionMgr := FALSE;				gSystem.hasHelpMgr := FALSE;				IF (gSystem.hasScriptMgr) THEN					gSystem.scriptsInstalled := GetEnvirons(smEnabled);			END;	END;(******************************************************************************}{ MakeDesktop}{}{		Create the global Desktop object, which is the top level of}{		the visual hierarchy. Overrride this method to use a desktop}{		which supports floating windows or other extensions to the}{		standard desktop.}{ ******************************************************************************)PROCEDURE CApplication.MakeDesktop;	BEGIN	(* Use a standard Desktop			*)		NEW(gDesktop);		gDesktop.IDesktop(SELF);	END;(******************************************************************************}{ MakeClipboard}{}{		Create the global Clipboard object}{ ******************************************************************************)PROCEDURE CApplication.MakeClipboard;	BEGIN	(* Use standard Clipboard			*)		NEW(gClipboard);		gClipboard.IClipboard(SELF, TRUE);	END;(******************************************************************************}{ MakeDecorator}{}{		Create the global Decorator object, which controls the}{		arrangement of windows on the screen. Override if a}{		different Decorator is desired.}{ ******************************************************************************)PROCEDURE CApplication.MakeDecorator;	BEGIN	(* Use standard Decorator			*)		NEW(gDecorator);		gDecorator.IDecorator;	END;(******************************************************************************}{ MakeSwitchboard}{}{ 	Create application's switchboard. Override if a different switchboard}{ 	is desired.}{******************************************************************************)PROCEDURE CApplication.MakeSwitchboard;	VAR		switchboard: CSwitchboard;	BEGIN		NEW(switchboard);		itsSwitchboard := switchboard;		itsSwitchboard.ISwitchboard;	END;(******************************************************************************}{ MakeBartender}{}{ 	Create global bartender. Override if a different bartender}{ 	is desired.}{******************************************************************************)PROCEDURE CApplication.MakeBartender;	BEGIN		NEW(gBartender);		gBartender.IBartender(MBARapp);	END;(******************************************************************************}{ MakeError}{}{ 	Create global error handler. Override if a different error handler}{ 	is desired.}{******************************************************************************)PROCEDURE CApplication.MakeError;	BEGIN		NEW(gError);	END;(******************************************************************************}{ SetUpFileParameters}{}{		Set values of the parameters used by the Standard File Package.}{ ******************************************************************************)PROCEDURE CApplication.SetUpFileParameters;	BEGIN	(** Get File Parameters **)		sfNumTypes := -1;			(* Display all files				*)		sfFileTypes[0] := '????';	(* Just put something here			*)		sfFileFilter := NIL;		(* No extra filtering of files		*)		sfGetDLOGHook := NIL;		(* No special handling of items		*)		sfGetDLOGid := getDlgID;	(* Use built-in get dialog box		*)		sfGetDLOGFilter := NIL;	(* No special event processing		*)	END;(******************************************************************************}{ SetUpMenus}{}{		Set up the menus used by the application}{ ******************************************************************************)PROCEDURE CApplication.SetUpMenus;	BEGIN		MakeBartender;		AddResMenu(GetMHandle(MENUapple), 'DRVR');		gBartender.SetDimOption(MENUapple, dimNONE);	END;(**** A C T I O N   M E T H O D S ****)(******************************************************************************}{ Notify {OVERRIDE}(*A subordinate is notifying the Application that a task has been completed . *)(******************************************************************************}PROCEDURE CApplication.Notify (theTask: CTask);	(* The completed task		*)	BEGIN		unhandledTask := theTask;	END;(******************************************************************************}{ DoKeyDown {OVERRIDE}{Respond to a keystroke . Application has no supervisor to whom to pass the buck . Default action is to ignore keystrokes}(******************************************************************************}PROCEDURE CApplication.DoKeyDown (theChar: Char;			(* The associated character			*)								keyCode: Byte;			(* Code for the associated key		*)								macEvent: EventRecord);(* Key down event record			*)	BEGIN	(* Null Method						*)	END;(******************************************************************************}{ DoAutoKey {OVERRIDE}{Respond to a key being held down . By default , keystrokes are ignored . }(******************************************************************************}PROCEDURE CApplication.DoAutoKey (theChar: Char;			(* The associated character			*)								keyCode: Byte;			(* Code for the associated key		*)								macEvent: EventRecord);(* auto key event record			*)	BEGIN	(* Null Method						*)	END;(******************************************************************************}{ DoKeyUp {OVERRIDE}{Respond to a key being released . Usually , these events will be masked out by the operating system . Ignore them by default .}(******************************************************************************}PROCEDURE CApplication.DoKeyUp (theChar: Char;			(* The associated character			*)								keyCode: Byte;			(* Code for the associated key		*)								macEvent: EventRecord);(* Key up event record			*)	BEGIN	(* Null Method						*)	END;(******************************************************************************}{ DoCommand}{}{		Handle a command. Application has no supervisor which can handle the}{		command. If we don't handle the command here, it will never be}{		executed (and that's an error).}(******************************************************************************}PROCEDURE CApplication.DoCommand (theCommand: Longint); (* Command number	*)	VAR		theDA: Str255;			(* Name of Desk Accessory to open	*)		macSFReply: SFReply;	(* Standard File reply record		*)		ignore: Integer;	BEGIN		IF (theCommand < 0) THEN			BEGIN			(* Open a DA or launch another		*)			(*   application under MultiFinder	*)				IF (HiWord(-theCommand) = MENUapple) THEN					BEGIN						GetItem(GetMHandle(MENUapple), LoWord(-theCommand), theDA);						ignore := OpenDeskAcc(theDA);					END;			END		ELSE			BEGIN				CASE theCommand OF					cmdNew: 						BEGIN							SetCursor(gWatchCursor^^);							CreateDocument;						END;					cmdOpen: 						BEGIN							ChooseFile(macSFReply);							IF (macSFReply.good) THEN								BEGIN									SetCursor(gWatchCursor^^);									OpenDocument(macSFReply);								END;						END;					cmdClose: 						IF (IsSystemWindow(WindowPeek(FrontWindow))) THEN							CloseDeskAcc(WindowPeek(FrontWindow)^.windowKind);					cmdQuit: 						IF Quit THEN							;					cmdUndo, cmdCut, cmdCopy, cmdPaste, cmdClear: 						IF SystemEdit(Integer((theCommand - cmdUndo))) THEN							;					cmdToggleClip: 						gClipboard.Toggle;				END;			END;	END;(******************************************************************************}{ UpdateMenus {OVERRIDE}{Perform menu management tasks}(******************************************************************************}PROCEDURE CApplication.UpdateMenus;	VAR		undoStr: Str255;		topWindow: CWindow;		isModalWindow: Boolean;	BEGIN		(* Is the frontmost window modal? *)		topWindow := gDesktop.GetTopWindow;		IF topWindow <> NIL THEN			isModalWindow := topWindow.IsModal		ELSE			isModalWindow := FALSE;		gBartender.EnableCmd(cmdQuit);		IF (gInBackground) THEN			BEGIN				gBartender.EnableCmd(cmdClose);				gBartender.EnableCmd(cmdUndo);				gBartender.EnableCmd(cmdCut);				gBartender.EnableCmd(cmdCopy);				gBartender.EnableCmd(cmdPaste);				gBartender.EnableCmd(cmdClear);			END		ELSE IF (NOT isModalWindow) THEN			BEGIN				gBartender.EnableCmd(cmdToggleClip);			END;		IF (NOT rainyDayUsed AND NOT isModalWindow) THEN			BEGIN				gBartender.EnableCmd(cmdNew);				gBartender.EnableCmd(cmdOpen);			END;		GetIndString(undoStr, STRcommon, strUNDO);		gBartender.SetCmdText(cmdUndo, undoStr);(**** M E M O R Y   M A N A G E M E N T ****)	END;(******************************************************************************}{ RequestMemory}{ }{ 	Indicate whether subsequent memory requests can fail if not enough}{ 	memory is available.}{ ******************************************************************************)PROCEDURE CApplication.RequestMemory (aCanFail: Boolean);	BEGIN		canFail := aCanFail;	END;(******************************************************************************}{ SetCriticalOperation}{ }{ 	Indicate whether subsequent memory requests should be regarded as}{ 	part of a critical operation. Critical operations can use more of the memory}{ 	reserve to ensure that they succeed. }{ 	}{ ******************************************************************************)PROCEDURE CApplication.SetCriticalOperation (fInCriticalOperation: Boolean);	BEGIN		SELF.inCriticalOperation := fInCriticalOperation;	END;(******************************************************************************}{ GrowMemory}{}{		A memory request can't be filled by the Mac Memory Manager. Free up}{		memory if possible or gracefully shutdown.}{		}{		A rainy day fund of reserve memory is maintained to monitor low}{		memory conditions. If the application can't free up enough memory}{		on its own, we use the reserve fund. The user is notified when}{		we tap into the reserve fund so that he/she can take steps to free}{		up memory (perhaps by closing windows/files).}{		}{		If there is not enough memory in reserve to cover a request, we}{		notify the user of impending doom. The Toolbox Memory Manager will}{		return an error code of memFullErr. This will probably cause some kind}{		of System Bomb.}{		}{ ******************************************************************************)FUNCTION CApplication.GrowMemory (bytesNeeded: Longint): Longint;	VAR		bytesToFree: Longint;		rainyDayBalance: Longint;		grow: Longint;		success: Boolean;	BEGIN						(* Try to release some memory		*)		MemoryShortage(bytesNeeded);					(* See how much we still need		*)		bytesToFree := bytesNeeded - MaxMem(grow);		IF (bytesToFree < 1) THEN			BEGIN	(* Hooray! Enough memory was freed!	*)				GrowMemory := GROW_SUCCESS;	(*   Let's get out of here			*)				Exit(GrowMemory);				;			END;		success := FALSE;		IF (rainyDay <> NIL) THEN			BEGIN				rainyDayBalance := GetHandleSize(rainyDay);				IF (inCriticalOperation) THEN					BEGIN						IF (rainyDayBalance - bytesToFree + tempAllocation >= toolboxBalance) THEN							BEGIN								SetHandleSize(rainyDay, rainyDayBalance - bytesToFree);								success := TRUE;							END;					END				ELSE					BEGIN						IF (rainyDayBalance - bytesToFree + tempAllocation >= criticalBalance) THEN							BEGIN								SetHandleSize(rainyDay, rainyDayBalance - bytesToFree);								success := TRUE;							END;					END;				IF (NOT success AND NOT canFail) THEN					BEGIN						IF (rainyDayBalance - bytesToFree >= MINIMUM_BALANCE) THEN							BEGIN					(* We have enough savings to cover	*)					(*   the request and maintain our	*)					(*   minimum balance				*)								SetHandleSize(rainyDay, MINIMUM_BALANCE);								success := TRUE;							END						ELSE							BEGIN								DisposHandle(rainyDay);								rainyDay := NIL;								success := TRUE;							END;					END;				IF (success) THEN					BEGIN						gSleepTime := 0;	  (* Idle as soon as possible			*)						rainyDayUsed := TRUE; (* We've tapped the rainy day fund	*)					END;			END;		IF (success) THEN			GrowMemory := GROW_SUCCESS		ELSE			BEGIN				IF (canFail) THEN				(* Requestor is prepared for failure *)					GrowMemory := GROW_FAILURE				ELSE				(* Try the last resort*)					GrowMemory := OutOfMemory(bytesNeeded);			END;	END;(******************************************************************************}{ MemoryShortage}{ }{		There is not enough memory to fill a request. Try to free up some}{		memory. Subclasses should override this method.}{}{		The application should free all non-essential blocks of}{		memory (such as those used to cache data for speed or resources}{		marked as unpurgeable to allow for quick access) and disable}{		commands which could consume a lot of memory (such as opening files}{		or creating new documents). The rainy day fund created by InitMemory}{		should be large enough to allow (or even force) the user to take}{		actions to reduce the memory strain without losing data (such as}{		closing windows/files).}{}{		IMPORTANT: This method should NOT allocate any blocks of memory.}{ ******************************************************************************)PROCEDURE CApplication.MemoryShortage (bytesNeeded: Longint);	BEGIN	(* Null Method						*)	END;(******************************************************************************}{ MemoryReplenished}{ }{ 		The rainy day fund of reserve memory has been replenished.}{ 		Subclasses must override this method if certain actions taken}{ 		by the MemoryShortage method need to be undone. For example, if}{ 		the "Open..." command was disabled by MemoryShortage, it should}{ 		be enabled here.}{ ******************************************************************************)PROCEDURE CApplication.MemoryReplenished;	BEGIN	(* Null Method						*)	END;(******************************************************************************}{ OutOfMemory}{ }{ 		A memory request cannot be satisfied. At this point, the rainy day}{ 		fund has been liquidated. This method posts an Alert if there's}{ 		enough memory to do so, and then jumps back to the event loop.}{ 		Classes which override this method should pass back the appropriate}{ 		return value (same as that for a GrowZone function) if necessary.}{ 		This method performs a long jump, so no return value is needed.}{ ******************************************************************************)FUNCTION CApplication.OutOfMemory (bytesNeeded: Longint): Longint;	BEGIN		Failure(memFullErr, 0);	END;(**** E X E C U T I O N   M E T H O D S ****)(******************************************************************************}{ Run}{ }{		Run the application by processing events.}{ ******************************************************************************)		(*}{		 * Perform a Chore}{		 *)PROCEDURE Chore_Perform (theChore: CChore;								VAR minSleep: Longint;								VAR maxSleep: Longint);	BEGIN		maxSleep := MAXLONGINT;		theChore.Perform(maxSleep);		minSleep := Min(minSleep, maxSleep);	END;PROCEDURE CApplication.Run;	VAR		fi: FailInfo;	PROCEDURE MainExceptionHandler (error: Integer;									message: Longint);		BEGIN		(*}{		 *	All exceptions (other than application initialization and cleanup)}{		 *	are ultimately caught here. We display an alert to tell the}{		 *	user what happened, and then do a retry to keep the application}{		 *	going.}{		 *	Special case if the error code is kSilentFailure. This tells}{		 *	that either an alert has already been displayed or none is}{		 *	desired.}{		 *)			IF (gLastError <> kSilentErr) THEN				ErrorAlert(error, message);			HiliteMenu(0);			RetryException(fi)		END;	BEGIN		Preload;		CatchFailures(fi, MainExceptionHandler);						(* now that an exception handler is posted,		*)						(* mark the application as running				*)		phase := appRunning;		REPEAT 				(* Continuously poll for events		*)						(*   and respond to them			*)			Process1Event;		UNTIL NOT running;	(*   Until flag is turned off		*)		phase := appQuitting; (* exception handler is about to be removed,	*)						  (* mark the app as quitting.					*)		Success;		RemovePatches;	END;(******************************************************************************}{ Process1Event}{ }{ 	Process and dispatch one event.}{******************************************************************************)PROCEDURE CApplication.Process1Event;	VAR		aDAIsActive: Boolean;		minSleep: Longint;	PROCEDURE Chore_Perform (theChore: CChore);		VAR			maxSleep: Longint;		BEGIN			maxSleep := MAXLONGINT;			theChore.Perform(maxSleep);		END;	BEGIN			(* Is a DA the front window?		*)		aDAIsActive := IsSystemWindow(WindowPeek(FrontWindow));		gDesktop.Cleanup;		itsSwitchboard.ProcessEvent;			(* A user command may have initiated a	*)			(* critical operation, e.g. Save, but	*)			(* it is complete once the event is handled*)		SetCriticalOperation(FALSE);			(* any temporary allocations should have been*)			(* released by now.*)		tempAllocation := 0;		gLastError := 0;		gLastMessage := 0;		IF (urgentsToDo) THEN			BEGIN				(* Carry out urgent chores			*)				itsUrgentChores.DoForEach(Chore_Perform);				itsUrgentChores.DisposeItems;				urgentsToDo := FALSE;			END;		(* Check for context-switch with	*)		(*   Desk Accessories				*)		IF (IsSystemWindow(WindowPeek(FrontWindow))) THEN			BEGIN				gSleepTime := 0;				IF (NOT aDAIsActive) THEN					BEGIN						aDAIsActive := TRUE;						SwitchToDA;					END;			END		ELSE			BEGIN				IF (aDAIsActive) THEN					BEGIN						aDAIsActive := FALSE;						SwitchFromDA;					END;			END;		ForceNextPrepare;		ForgetObject(unhandledTask);	END;(******************************************************************************}{ Preload}{ }{		Open/Print files selected by the user from the Finder before}{		launching the application}{ ******************************************************************************)PROCEDURE CApplication.Preload;	VAR		openOrPrint: Integer;	(* Type of action requested			*)		numPreloads: Integer;	(* No. of files to process			*)		i: Integer;			(* Index for files					*)		macAppFile: AppFile;	(* Info about a file				*)		macSFReply: SFReply;	(* Standard File info record		*)	BEGIN		(* Check if files were selected		*)		CountAppFiles(openOrPrint, numPreloads);		(* Process files one by one			*)		IF numPreloads > 0 THEN			BEGIN				SetCursor(gWatchCursor^^);				FOR i := 1 TO numPreloads DO					BEGIN				(* Get info about the file			*)						GetAppFiles(i, macAppFile);				(* Copy info into a Standard File 	*)				(*   record							*)						macSFReply.fType := macAppFile.fType;						macSFReply.vRefNum := macAppFile.vRefNum;						macSFReply.version := macAppFile.versNum;						macSFReply.fName := macAppFile.fName;				(* Automatically open selected file	*)						OpenDocument(macSFReply);						IF (openOrPrint = appPrint) THEN							BEGIN					(* User wants to print Document		*)								gDesktop.UpdateWindows;								gGopher.DoCommand(cmdPrint);							END;				(* We've processed this file		*)						ClrAppFiles(i);					END;			END;		(* Perform start up action			*)		StartUpAction(numPreloads);	END;(******************************************************************************}{ StartUpAction}{ }{		Perform any desired start up action. This method is invoked after}{		files selected from the Finder have been opened/printed. The number}{		of preloaded files is passed as a parameter. If no files were}{		preloaded, this default method acts as if the user selected "New"}{		and sends the Gopher a DoCommand(cmdNew) message.}{ ******************************************************************************)PROCEDURE CApplication.StartUpAction (numPreloads: Integer);	VAR		waitForOAPP: Boolean;	BEGIN		FlushEvents(everyEvent, 0);		(* TCL 1.1 - only do cmdNew if there are no AppleEvents.*)		(* If there are, we anticipate getting the open app event*)		(* Under the THINK Pascal environment, we don't get an	*)		(* initial oapp. We use the compiler variable TCL_DEBUG *)		(* to determine if we're running the debug version.		*)		(* If we are, we don't wait for the oapp event.			*)		waitForOAPP := gSystem.hasAppleEvents;{$IFC TCL_DEBUG}		waitForOAPP := FALSE; {$ENDC}		IF (NOT waitForOAPP) AND (numPreloads = 0) THEN			gGopher.DoCommand(cmdNew);	END;(******************************************************************************}{ Suspend}{ }{		Program is about to be swapped out under MultiFinder. Send the}{		Suspend message to each of the Application's Directors.}{ ******************************************************************************)PROCEDURE CApplication.Suspend;	BEGIN		INHERITED Suspend;		(* We are going into the background	*)		gInBackground := TRUE;	END;(******************************************************************************}{ Resume}{ }{		Program is being swapped in under MultiFinder}{ ******************************************************************************)PROCEDURE CApplication.Resume;	BEGIN		ForceNextPrepare;			(* Do nothing if a DA is in front	*)		IF (NOT IsSystemWindow(WindowPeek(FrontWindow))) THEN			BEGIN				gInBackground := FALSE;				INHERITED Resume;			END;	END;(******************************************************************************}{ SwitchToDA}{ }{		A DA is becoming active}{ ******************************************************************************)PROCEDURE CApplication.SwitchToDA;	BEGIN		LongPtr(CurDeactive)^ := 0;		Suspend;	END;(******************************************************************************}{ SwitchFromDA}{ }{		Our application is becoming active after a DA had been running}{ ******************************************************************************)PROCEDURE CApplication.SwitchFromDA;	BEGIN		LongPtr(CurActivate)^ := 0;		Resume;	END;(******************************************************************************}{ Quit}{ }{		User requested quit. Need to perform a graceful shutdown,}{		giving the user the opportunity to save changed files or to abort}{		the quit process.}{ ******************************************************************************)FUNCTION CApplication.Quit: Boolean;	VAR		theWindow: CWindow;		theDirector: CDirector;	BEGIN				(* Assume we will stop running		*)		running := FALSE;				(*   (Does not include floating		*)				(*    windows or DAs)				*)		theWindow := gDesktop.GetTopWindow;		WHILE theWindow <> NIL DO			BEGIN				theDirector := CDirector(theWindow.GetSupervisor);				(* Tell window's Director to quit	*)				(*   If Quit method returns FALSE,	*)				(*   abort the quit sequence		*)				IF (NOT theDirector.Quit) THEN					BEGIN				(* User still wants to run program	*)						running := TRUE;						LEAVE;					END;				theWindow := gDesktop.GetTopWindow;			END;		Quit := NOT running;	{ TCL 1.1.1 DLP 9/25/91 }	END;(******************************************************************************}{ Exit}{ }{		Program is about to terminate. Last chance to clean up.}{ ******************************************************************************)PROCEDURE CApplication.ExitApp;	BEGIN(* NULL Method						*)	END;(******************************************************************************}{ JumpToEventLoop}{ }{		Jump to the beginning of the main event loop. Useful when trying}{		to recover from an error.}{		}{		An error may occur BEFORE program ever gets to the event loop. In}{		this case the jump buffer entry for A1 (the address to jump to) will}{		be NULL and we exit the program.}{ ******************************************************************************)PROCEDURE CApplication.JumpToEventLoop;	BEGIN	(*}{	 *	This call to Failure produces nearly the same result as the previous code.}{	 *	If we are called within the activation of CApplication.Run,}{	 *	then we jump to the event loop. Otherwise we jump to the}{	 *	default handler posted in main, wich calls CApplication.Exit}{	 *	followed by ExitToShell.}{	 *}{	 *	The only difference is that Failure will also cause any other}{	 *	pending exception handlers to be called, which is really the}{	 *	correct thing to do.}{	 *)		Failure(kSilentErr, 0);		(* kSilentErr inhibits the error alert *)	END;(**** D O C U M E N T   H A N D L I N G   M E T H O D S ****)(******************************************************************************}{ CreateDocument}{ }{		Make a document in response to the "New" menu selection. This method}{		must be overridden if the standard "New" command is used.}{ ******************************************************************************)PROCEDURE CApplication.CreateDocument;	BEGIN	(* NULL Method						*)	END;(******************************************************************************}{ OpenDocument}{ }{		Open an existing file and create a document object for displaying}{		information. This method must be overridden if the standard "Open"}{		command is used.}{ ******************************************************************************)PROCEDURE CApplication.OpenDocument (macSFReply: SFReply);	BEGIN	(* NULL Method						*)	END;(******************************************************************************}{ ChooseFile}{ }{		Let the user select a file to open. Default procedure is to use}{		the Standard GetFile dialog box.}{ ******************************************************************************)PROCEDURE CApplication.ChooseFile (VAR macSFReply: SFReply);	VAR		corner: Point;		(* Top left corner of dialog box	*)		wasLocked: Boolean;	BEGIN			(* Center dialog box on the screen	*)		FindDlogPosition('DLOG', sfGetDLOGid, corner);		wasLocked := Lock(TRUE);		SFPGetFile(corner, '', sfFileFilter, sfNumTypes, sfFileTypes, sfGetDLOGHook, macSFReply, sfGetDLOGid, sfGetDLOGFilter);		wasLocked := Lock(wasLocked);	END;(**** C H O R E   H A N D L I N G   M E T H O D S ****)(******************************************************************************}{ Idle}{}{		No event directed to our application is pending. Here's our chance}{		to perform periodic tasks. The classic example is flashing a}{		text insertion cursor.}{ ******************************************************************************)PROCEDURE CApplication.Idle (macEvent: EventRecord); (* Usually a null or system event	*)	VAR		grow: Longint;	(* Amount heap may be grown			*)		theBureaucrat: CBureaucrat;		minSleep: Longint;		maxSleep: Longint;	PROCEDURE Chore_Perform (theChore: CChore);		BEGIN			maxSleep := MAXLONGINT;			theChore.Perform(maxSleep);			minSleep := Min(minSleep, maxSleep);		END;	BEGIN		IF (rainyDayUsed) THEN		(* Memory reserve needs to be		*)		(*   replenished					*)			BEGIN				IF (MaxMem(grow) > rainyDayFund + MINIMUM_BALANCE) THEN					BEGIN			(* Enough memory has been freed		*)						IF (rainyDay <> NIL) THEN							BEGIN								DisposHandle(rainyDay);							END;						rainyDay := NewHandle(rainyDayFund);						rainyDayUsed := FALSE;						memWarningIssued := FALSE;						MemoryReplenished;					END				ELSE IF (NOT memWarningIssued) THEN					BEGIN				(* Inform user of memory shortage	*)						gError.PostAlert(STRmemWarn, iMEM_LOW);						memWarningIssued := TRUE;					END;			END;				(* Idle time for objects in the		*)				(*   active chain of command		*)				(* Run thru the chain of command	*)				(* Start at the bottom				*)		theBureaucrat := gGopher;		minSleep := cMaxSleepTime;		REPEAT			maxSleep := MAXLONGINT;				(*   Let bureaucrat kill some time	*)			theBureaucrat.Dawdle(maxSleep);			minSleep := Min(minSleep, maxSleep);				(*   Move up to his/her boss		*)			theBureaucrat := theBureaucrat.itsSupervisor;				(* Until end of command chain		*)		UNTIL theBureaucrat = NIL;				(* Carry out assigned chores		*)		itsIdleChores.DoForEach(Chore_Perform);		gSleepTime := minSleep;	END;(******************************************************************************}{ AssignIdleChore}{ }{		Give Application a chore to perform at idle time. Idle chores are}{		performed whenever there are no events pending for the Application.}{ ******************************************************************************)PROCEDURE CApplication.AssignIdleChore (theChore: CChore);	BEGIN		itsIdleChores.Add(theChore);				(* Force immediate idle				*)		gSleepTime := 0;	END;(******************************************************************************}{ CancelIdleChore}{ }{		Relieve Application of an idle time chore. A chore must NOT cancel}{		itself or any other chore.}{ ******************************************************************************)PROCEDURE CApplication.CancelIdleChore (theChore: CChore);	BEGIN		itsIdleChores.Remove(theChore);	END;(******************************************************************************}{ AssignUrgentChore}{ }{		Give Application a chore to perform as soon as possible. Urgent}{		chores are performed only once, then automatically disposed.}{		An urgent chore must NOT post another urgent chore.}{ ******************************************************************************)PROCEDURE CApplication.AssignUrgentChore (theChore: CChore);	BEGIN		itsUrgentChores.Add(theChore);		urgentsToDo := TRUE;	END;(******************************************************************************}{ GetPhase}{ }{ 	Return the instance variable representing the current application phase.}{ 	The valid values are appInitializing, appRunning, or appQuiting.}{******************************************************************************)FUNCTION CApplication.GetPhase: Integer;	BEGIN		GetPhase := phase;	END;(******************************************************************************}{ DoOpenOrPrintDocEvent}{}{	Handle the kAEOpenDocuments, kAEPrintDocuments AppleEvents}{ ******************************************************************************)PROCEDURE CApplication.DoOpenOrPrintDocEvent (theEvent: CAppleEvent);	VAR		docList: CArray;		i: Longint;		numDocs: Longint;		currDoc: FSSpec;		eventID: DescType;		fi: FailInfo;		wdRefNum: Integer;		reply: SFReply;		fileInfo: FInfo;	PROCEDURE AEExceptionHandler (error: Integer;									message: Longint);		BEGIN			ForgetObject(docList);		END;	BEGIN		docList := NIL;		CatchFailures(fi, AEExceptionHandler);		SetCursor(gWatchCursor^^);		docList := theEvent.ExtractFromDescList(keyDirectObject, typeFSS, SIZEOF(FSSpec));		IF (theEvent.GotRequiredParams) THEN			BEGIN				eventID := theEvent.GetEventID;				numDocs := docList.GetNumItems;				FOR i := 1 TO numDocs DO					BEGIN						docList.GetItem(@currDoc, i);						FailOSErr(OpenWD(currDoc.vRefNum, currDoc.parID, Longint(gSignature), wdRefNum));						FailOSErr(FSpGetFInfo(currDoc, fileInfo));						reply.good := TRUE;						reply.vRefNum := wdRefNum;						reply.fType := fileInfo.fdType;						reply.version := 0;						reply.copy := FALSE;						reply.fName := currDoc.name;						OpenDocument(reply);						IF (eventID = kAEPrintDocuments) THEN							BEGIN								gDesktop.UpdateWindows;								gGopher.DoCommand(cmdPrint);								gGopher.DoCommand(cmdClose);							END;					END;		(* event was handled successfully*)				theEvent.SetErrorResult(noErr);				ForgetObject(docList);				Success;			END;	END;(******************************************************************************}{ PackageAppleEvent}{}{	Package an incoming AppleEvent and its default reply into a CAppleEvent}{	object. This method always returns an object of class CAppleEvent, but}{	you may wish to override it and return your own subclass of CAppleEvent.}{	}{ ******************************************************************************)FUNCTION CApplication.PackageAppleEvent (theEvent: AppleEvent;								theReply: AppleEvent;								theRefCon: Longint;								eventClass: DescType;								eventID: DescType): CAppleEvent;	VAR		event: CAppleEvent;	BEGIN		NEW(event);		event.IAppleEvent(theEvent, theReply, theRefCon, eventClass, eventID);		PackageAppleEvent := event;	END;(******************************************************************************}{ DoAppleEvent {OVERRIDE}{Respond to an AppleEvent . This method handles the four required AppleEvents : kAEOpenApplication , kAEOpenDocuments , kAEPrintDocuments , and kAEQuitApplication .}(******************************************************************************}PROCEDURE CApplication.DoAppleEvent (anAppleEvent: CAppleEvent);	VAR		eventClass: DescType;		eventID: DescType;		err: Integer;	BEGIN		eventClass := anAppleEvent.GetEventClass;		eventID := DescType(anAppleEvent.GetEventID);		IF (eventClass = kCoreEventClass) THEN			BEGIN				IF (eventID = kAEOpenApplication) THEN					BEGIN						IF (anAppleEvent.GotRequiredParams) THEN							BEGIN								gGopher.DoCommand(cmdNew);								anAppleEvent.SetErrorResult(noErr);							END;					END				ELSE IF (eventID = kAEOpenDocuments) THEN					BEGIN						DoOpenOrPrintDocEvent(anAppleEvent);					END				ELSE IF (eventID = kAEPrintDocuments) THEN					BEGIN						err := anAppleEvent.RequestInteraction(MAXLONGINT);						IF (err = noErr) THEN							DoOpenOrPrintDocEvent(anAppleEvent)						ELSE							anAppleEvent.SetErrorResult(err);					END				ELSE IF (eventID = kAEQuitApplication) THEN					BEGIN						IF (anAppleEvent.GotRequiredParams) THEN							err := anAppleEvent.RequestInteraction(MAXLONGINT);						IF (err = noErr) THEN							IF Quit THEN								;							(* if we're still running then Quit didn't succeed	*)							(* but we don't know what error to report!			*)						anAppleEvent.SetErrorResult(err);					END;			END;	END;END.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    2  P*¨  ÿ0 ¶  (5º6  ø P*¨      CApplication.pC   TEXTPJMM@     TEXTPJMM@                       ¤TF…      L                                                                                                    CopyVers                        €   1.1.2	TCL 1.1.2           2 i’œü    2  vers   
 ÿÿ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            (******************************************************************************}{ CArray.p}{}{		Implements a dynamically sized array. Elements may be of any}{		size, but all elements must be the same size.}{		}{	SUPERCLASS = CCollection}{	}{	Copyright © 1991 Symantec Corporation. All rights reserved.}{	}{}{ ******************************************************************************)UNIT CArray;INTERFACEUSES	TCL;IMPLEMENTATIONPROCEDURE CArray.AssertIndex (index: Longint);	BEGIN		ASSERT((index > 0) & (index <= numItems));	END;FUNCTION CArray.GetItemPtr (index: Longint): Ptr;	BEGIN		GetItemPtr := Ptr(Longint(hItems^) + ((index - 1) * elementSize));	END;(******************************************************************************}{ IArray}{}{		Initialize an array object, specifying the element size. The}{		initialized array is empty.}{}{ ******************************************************************************)PROCEDURE CArray.IArray (anElementSize: Longint);	BEGIN									(* Initialize superclass			*)		ICollection;		blockSize := 3;		elementSize := anElementSize;		slots := 0;		lockChanges := FALSE;		usingTemporary := FALSE;		hItems := NewHandleCanFail(elementSize);		FailNIL(hItems);	END;(******************************************************************************}{ Free [OVERRIDE]}{}{		Dispose of an Array. }{ ******************************************************************************)PROCEDURE CArray.Free;	BEGIN						(* Free handle to items				*)		ForgetHandle(hItems);						(* Pass message on to superclass	*)		INHERITED Free;	END;(******************************************************************************}{ SetBlockSize}{}{		Set the blockSize which specifies the number of empty slots to}{		allocate when more space is needed.}{ ******************************************************************************)PROCEDURE CArray.SetBlockSize (aBlockSize: Integer);	BEGIN								(* Set instance variable			*)		blockSize := aBlockSize;	END;(******************************************************************************}{ Set}{}{	Set the value of the element at index. Index must be within the array.}{	Sends dependents an arrayElementChanged message.}{	}{ ******************************************************************************)PROCEDURE CArray.SetItem (itemPtr: UNIV Ptr;								index: Longint);	BEGIN		AssertIndex(index);		Store(itemPtr, index);		BroadcastChange(arrayElementChanged, @index);	END;(******************************************************************************}{ Store}{}{	Private method to set an array element.}{ ******************************************************************************)PROCEDURE CArray.Store (itemPtr: UNIV Ptr;								index: Longint);	BEGIN		BlockMove(itemPtr, GetItemPtr(index), elementSize);	END;(******************************************************************************}{ Get}{}{	Retrieve the value of the array element. Index must be within the array.}{	itemPtr must point to storage of sufficient size to hold one element.}{ ******************************************************************************)PROCEDURE CArray.GetItem (itemPtr: UNIV Ptr;								index: Longint);	BEGIN		AssertIndex(index);		Retrieve(itemPtr, index);	END;(******************************************************************************}{ Retrieve}{}{	Private method to retrieve an array element.}{ ******************************************************************************)PROCEDURE CArray.Retrieve (itemPtr: UNIV Ptr;								index: Longint);	BEGIN		BlockMove(GetItemPtr(index), itemPtr, elementSize);	END;(******************************************************************************}{ InsertAtIndex}{}{		Insert an item into the array at the specified index. Any items}{		at or above index are moved down. If index is any value greater}{		than the current size, then the item is appended to the end}{		of the array.}{		Sends dependents an arrayInsertElement message.}{}{ ******************************************************************************)PROCEDURE CArray.InsertAtIndex (itemPtr: UNIV Ptr;								index: Longint);	BEGIN		ASSERT(index > 0);		ASSERT(lockChanges = FALSE);		IF (lockChanges) THEN			EXIT(InsertAtIndex);								(* Check if we need more space		*)		IF (numItems >= slots) THEN			MoreSlots;								(* Move items at position >= index	*)								(*   down one slot, unless it is	*)								(*   the last item					*)		IF (index <= numItems) THEN			BlockMove(GetItemPtr(index), GetItemPtr(index + 1), (numItems - index + 1) * elementSize)		ELSE			index := numItems + 1;								(* There's another item in the list	*)		numItems := numItems + 1;								(* Stick new object in the empty slot*)		Store(itemPtr, index);		BroadcastChange(arrayInsertElement, @index);	END;(******************************************************************************}{ DeleteItem}{}{	Delete an item from the Array. Index must be within the array.}{	Sends dependents an arrayDeleteElement message.}{}{ ******************************************************************************)PROCEDURE CArray.DeleteItem (index: Longint);	BEGIN		AssertIndex(index);		ASSERT(lockChanges = FALSE);		IF (lockChanges) THEN			EXIT(DeleteItem);										(* We're gonna get rid of an item	*)		numItems := numItems - 1;		IF (index <= numItems) THEN									(* Shift items following the object	*)									(*   to remove up one slot, thereby	*)									(*   overwriting it					*)			BlockMove(GetItemPtr(index + 1), GetItemPtr(index), (numItems - index + 1) * elementSize);		IF (slots > numItems + blockSize) THEN									(* The number of free slots is		*)									(*   greater than the blockSize.	*)									(*   Reduce the size of the items	*)									(*   handle.						*)			Resize(slots - blockSize);		BroadcastChange(arrayDeleteElement, @index);	END;(******************************************************************************}{ Resize}{}{ 	Resize an array to the desired number of slots. numItems is not affected.}{******************************************************************************)PROCEDURE CArray.Resize (numSlots: Longint);	BEGIN								(* Be sure to take the scratch		*)								(* element storage at the end 		*)								(* of the handle into account when	*)								(* resizing	the item handle			*)		slots := numSlots;		ResizeHandleCanFail(hItems, (slots + 1) * elementSize);		FailMemError;	END;(******************************************************************************}{ MoreSlots}{}{		Grows the array by blockSize slots.}{ ******************************************************************************)PROCEDURE CArray.MoreSlots;	BEGIN		Resize(slots + blockSize);	END;(******************************************************************************}{ MoveItemToIndex}{}{		Move an element to a specified position in the array, shifting}{		other element in the list appropriately.}{		Sends dependents an arrayMoveElement message.}{ ******************************************************************************)PROCEDURE CArray.MoveItemToIndex (currentIndex: Longint;								newIndex: Longint);	VAR		moveInfo: tMovedElementInfo;	BEGIN		AssertIndex(currentIndex);		AssertIndex(newIndex);		IF (currentIndex = newIndex) THEN			EXIT(MoveItemToIndex);			(* In order to move the item, we must first make a copy of it.	*)			(* Since the items could be of any size, we keep storage for	*)			(* exactly one item at the end of the items handle. In order	*)			(* to guard against the two methods simultaneously using the	*)			(* temporary buffer, we mark it in use by setting the			*)			(* usingTemporary instance variable.							*)		CopyToTemporary(currentIndex);		IF (currentIndex < newIndex) THEN			BEGIN										(* Element is before target location*)										(* Shift items between current		*)										(*   and target locations down one	*)				BlockMove(GetItemPtr(currentIndex + 1), GetItemPtr(currentIndex), (newIndex - currentIndex) * elementSize);			END		ELSE IF (currentIndex > newIndex) THEN			BEGIN										(* Element is after target location	*)										(* Shift items between target and	*)										(*   current locations up one		*)				BlockMove(GetItemPtr(newIndex), GetItemPtr(newIndex + 1), (currentIndex - newIndex) * elementSize);			END;									(* copy element into new position *)		CopyFromTemporary(newIndex);		moveInfo.originalIndex := currentIndex;		moveInfo.newIndex := newIndex;		BroadcastChange(arrayMoveElement, @moveInfo);	END;(******************************************************************************}{ SetLockChanges}{}{ 	Set the lockChanges instance variable and return its old value. Setting}{ 	lockChanges to TRUE prevents the InsertAtIndex and Delete methods}{ 	from operating.}{******************************************************************************)FUNCTION CArray.SetLockChanges (fLockChanges: Boolean): Boolean;	VAR		wasLocked: Boolean;	BEGIN		wasLocked := lockChanges;		lockChanges := fLockChanges;		SetLockChanges := wasLocked;	END;(******************************************************************************}{ Search}{}{ 	Find an array element matching the data at itemPtr. compare is used }{ 	to perform the comparison and should be declared:}{}{		function compare( item1, item2: univ Ptr): Boolean}{		 		}{ 	and should return TRUE if the items are equivalent.}{ ******************************************************************************)FUNCTION CArray.Search (itemPtr: UNIV Ptr;								FUNCTION compare (item1, item2: UNIV Ptr): Boolean): Longint;	VAR		state: SignedByte;		items: Ptr;		i: Longint;		foundIndex: Longint;	BEGIN		state := HGetState(hItems);		HLock(hItems);		items := hItems^;		foundIndex := BAD_INDEX;		FOR i := 1 TO numItems DO			BEGIN				IF compare(itemPtr, GetItemPtr(i)) THEN					BEGIN						foundIndex := i;						leave;					END;			END;		HSetState(hItems, state);		Search := foundIndex;	END;(******************************************************************************}{ Swap}{}{ 	Swap two items. Sends dependents an arrayElementChanged message for both}{ 	items.}{ ******************************************************************************)PROCEDURE CArray.Swap (index1, index2: Longint);	BEGIN		AssertIndex(index1);		AssertIndex(index2);		CopyToTemporary(index1);		BlockMove(GetItemPtr(index2), GetItemPtr(index1), elementSize);		CopyFromTemporary(index2);		BroadcastChange(arrayElementChanged, @index1);		BroadcastChange(arrayElementChanged, @index2);	END;(******************************************************************************}{ CopyToTemporary}{}{ 	Place an item into temporary storage}{ ******************************************************************************)PROCEDURE CArray.CopyToTemporary (index: Longint);	BEGIN		ASSERT(usingTemporary = FALSE);		usingTemporary := TRUE;		BlockMove(GetItemPtr(index), GetItemPtr(numItems + 1), elementSize);	END;(******************************************************************************}{ CopyFromTemporary}{}{ 	Get an item from temporary storage}{******************************************************************************)PROCEDURE CArray.CopyFromTemporary (index: Longint);	BEGIN		ASSERT(usingTemporary = TRUE);		usingTemporary := FALSE;		BlockMove(GetItemPtr(numItems + 1), GetItemPtr(index), elementSize);	END;(******************************************************************************}{ ItemOffset}{}{ 	Get the offset of an item into the item handle}{******************************************************************************)FUNCTION CArray.ItemOffset (itemIndex: Longint): Longint;	BEGIN		AssertIndex(itemIndex);		ItemOffset := (itemIndex - 1) * elementSize;	END;(******************************************************************************}{ Clone}{}{ 	Make of copy of a CArray object. Override to copy the item handle }{******************************************************************************)FUNCTION CArray.Clone: CObject;	{ TCL 1.1.1 DLP 9/25/91 }	VAR		fi: FailInfo;		theCopy: CArray;		itemsCopy: Handle;		err: OSErr;		savedAlloc: Boolean;	PROCEDURE HandleFailure (error: Integer;									message: Longint);		BEGIN			(* if copying the item handle failed, then we should	*)			(* kill the copy created by CObject.Copy. We clear the	*)			(* item handle so disposing of the copy doesn't dispose	*)			(* of the array's item handle.							*)			theCopy.hItems := NIL;			theCopy.Free;		END;	BEGIN		theCopy := CArray(INHERITED Clone); { TCL 1.1.1 DLP 9/25/91 }		CatchFailures(fi, HandleFailure);		itemsCopy := theCopy.hItems;		savedAlloc := SetAllocation(kAllocCanFail);		err := HandToHand(itemsCopy);		savedAlloc := SetAllocation(savedAlloc);		FailOSErr(err);		theCopy.hItems := itemsCopy;		Success;		Clone := theCopy;	{ TCL 1.1.1 DLP 9/25/91 }	END;END.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    